# M2M100 中期优化集成测试说明

**日期：** 2025-01-23  
**状态：** ✅ 集成测试已创建

---

## 1. 测试概述

集成测试用于验证中期优化功能的端到端效果：

1. **TTS 增量播放自然化**（fade in/out、停顿）
2. **M2M100 翻译质量增强**（重复序列检测、质量检查）

---

## 2. 测试文件

**文件：** `core/engine/examples/test_s2s_integration_mid_optimization.rs`

**功能：**
- 完整的 S2S 流程测试（ASR → NMT → TTS）
- 启用所有中期优化功能
- 收集并验证 TTS 事件
- 验证音频增强和质量检查效果

---

## 3. 运行方法

### 3.1 前提条件

1. **Python M2M100 NMT 服务已启动**
   ```bash
   cd services/nmt_m2m100
   uvicorn nmt_service:app --host 127.0.0.1 --port 5008
   ```

2. **Piper TTS 服务已启动**（WSL2 中）
   ```bash
   # 在 WSL2 中
   cd scripts/wsl2_piper
   ./start_piper_service.sh
   ```

3. **Whisper ASR 模型已下载**
   - 模型路径：`core/engine/models/asr/whisper-base/`

4. **准备测试音频文件**
   - WAV 格式
   - 例如：`test_output/english.wav` 或 `test_output/chinese.wav`

### 3.2 运行测试

```bash
# 基本用法
cargo run --example test_s2s_integration_mid_optimization -- <input_wav_file>

# 指定翻译方向
cargo run --example test_s2s_integration_mid_optimization -- test_output/english.wav --direction en-zh

# 中文到英文
cargo run --example test_s2s_integration_mid_optimization -- test_output/chinese.wav --direction zh-en
```

---

## 4. 测试验证点

### 4.1 音频增强验证

- ✅ TTS 事件已生成
- ✅ 音频数据长度 > 0
- ✅ 音频增强已应用到每个短句

### 4.2 质量检查验证

- ✅ 质量检查已启用
- ✅ 重复序列检测正常工作
- ✅ 可疑质量检测正常工作

### 4.3 增量播放验证

- ✅ 文本已正确分割为短句
- ✅ 每个短句独立合成
- ✅ TTS 事件按顺序生成

---

## 5. 预期输出

```
=== 中期优化功能集成测试 ===

输入文件: test_output/english.wav
翻译方向: en-zh

[1/6] 加载音频文件...
  ✅ 已加载 5 个音频帧

[2/6] 初始化 Whisper ASR...
  ✅ ASR 初始化完成

[3/6] 初始化 M2M100 NMT 客户端...
  ✅ NMT 客户端初始化完成

[4/6] 初始化 Piper TTS...
  ✅ TTS 初始化完成

[5/6] 构建 CoreEngine（启用中期优化功能）...
  ✅ Engine 构建完成（已启用：增量播放、音频增强、质量检查）

[6/6] 启动 Engine 并处理音频...
  📝 ASR 识别: Hello, welcome to the test.
  📝 ASR 识别: How are you today?

  ✅ 处理完成
  📊 统计:
    - ASR 识别结果数: 2
    - TTS 事件数: 4

  ✅ 音频增强功能验证:
    - TTS 事件已生成（音频增强已应用）
    - 事件 1: 音频长度 12345 字节
    - 事件 2: 音频长度 12345 字节
    - 事件 3: 音频长度 12345 字节
    - 事件 4: 音频长度 12345 字节

  ✅ 翻译质量检查功能验证:
    - 质量检查已启用（重复序列检测、可疑质量检测）

=== 集成测试完成 ===

✅ 所有功能验证通过！
```

---

## 6. 故障排查

### 6.1 NMT 服务连接失败

**错误：** `Failed to send HTTP request to NMT service`

**解决：**
1. 检查 NMT 服务是否运行：`curl http://127.0.0.1:5008/health`
2. 确认服务地址和端口正确

### 6.2 TTS 服务连接失败

**错误：** `Failed to send HTTP request to Piper service`

**解决：**
1. 检查 TTS 服务是否运行：`curl http://127.0.0.1:5005/voices`
2. 确认 WSL2 端口转发正确

### 6.3 ASR 模型未找到

**错误：** `Whisper ASR 模型目录不存在`

**解决：**
1. 确认模型路径：`core/engine/models/asr/whisper-base/`
2. 下载 Whisper 模型到该目录

---

## 7. 下一步

1. **运行实际测试**：使用真实音频文件进行测试
2. **性能分析**：测量音频增强对延迟的影响
3. **质量评估**：对比启用/禁用质量检查的翻译结果

---

**文档生成时间：** 2025-01-23

