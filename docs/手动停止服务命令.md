# 手动停止服务命令

## Windows PowerShell

### 方法 1：按端口查找并终止进程（推荐）

```powershell
# 停止端口 5005 上的进程（TTS 服务）
Get-NetTCPConnection -LocalPort 5005 -ErrorAction SilentlyContinue | 
    ForEach-Object { Stop-Process -Id $_.OwningProcess -Force }

# 停止端口 5008 上的进程（NMT 服务）
Get-NetTCPConnection -LocalPort 5008 -ErrorAction SilentlyContinue | 
    ForEach-Object { Stop-Process -Id $_.OwningProcess -Force }

# 停止端口 9000 上的进程（CoreEngine）
Get-NetTCPConnection -LocalPort 9000 -ErrorAction SilentlyContinue | 
    ForEach-Object { Stop-Process -Id $_.OwningProcess -Force }
```

### 方法 2：一行命令（同时停止多个端口）

```powershell
# 停止端口 5005, 5008, 9000 上的所有进程
5005, 5008, 9000 | ForEach-Object {
    Get-NetTCPConnection -LocalPort $_ -ErrorAction SilentlyContinue | 
        ForEach-Object { Stop-Process -Id $_.OwningProcess -Force -ErrorAction SilentlyContinue }
}
```

### 方法 3：使用 netstat 和 taskkill

```powershell
# 查找并终止端口 5005 的进程
$port = 5005
$processId = (Get-NetTCPConnection -LocalPort $port -ErrorAction SilentlyContinue).OwningProcess
if ($processId) {
    taskkill /F /PID $processId
}

# 查找并终止端口 5008 的进程
$port = 5008
$processId = (Get-NetTCPConnection -LocalPort $port -ErrorAction SilentlyContinue).OwningProcess
if ($processId) {
    taskkill /F /PID $processId
}
```

### 方法 4：停止 WSL 中的 TTS 服务

```powershell
# 停止 WSL 中运行在端口 5005 的 TTS 服务
wsl bash -c "lsof -ti:5005 | xargs kill -9 2>/dev/null || pkill -f piper_http_server || true"
```

### 方法 5：按进程名停止

```powershell
# 停止所有 Python 进程（可能包括 NMT 服务）
Get-Process python, pythonw -ErrorAction SilentlyContinue | Stop-Process -Force

# 停止 CoreEngine
Get-Process core_engine -ErrorAction SilentlyContinue | Stop-Process -Force
```

## Linux/macOS (Bash)

### 方法 1：使用 lsof 和 kill（推荐）

```bash
# 停止端口 5005 上的进程（TTS 服务）
lsof -ti:5005 | xargs kill -9 2>/dev/null || echo "No process on port 5005"

# 停止端口 5008 上的进程（NMT 服务）
lsof -ti:5008 | xargs kill -9 2>/dev/null || echo "No process on port 5008"

# 停止端口 9000 上的进程（CoreEngine）
lsof -ti:9000 | xargs kill -9 2>/dev/null || echo "No process on port 9000"
```

### 方法 2：一行命令（同时停止多个端口）

```bash
# 停止端口 5005, 5008, 9000 上的所有进程
for port in 5005 5008 9000; do
    lsof -ti:$port | xargs kill -9 2>/dev/null || true
done
```

### 方法 3：使用 fuser（Linux）

```bash
# 停止端口 5005 上的进程
fuser -k 5005/tcp

# 停止端口 5008 上的进程
fuser -k 5008/tcp

# 停止端口 9000 上的进程
fuser -k 9000/tcp
```

### 方法 4：按进程名停止

```bash
# 停止所有 uvicorn 进程（NMT 服务）
pkill -f "uvicorn.*nmt_service" || pkill -f uvicorn

# 停止所有 piper 进程（TTS 服务）
pkill -f piper || pkill -f piper_http_server

# 停止 CoreEngine
pkill -f core_engine
```

## 快速检查端口占用

### Windows PowerShell

```powershell
# 检查端口占用情况（Windows 服务）
Get-NetTCPConnection -LocalPort 5005,5008,9000 -ErrorAction SilentlyContinue | 
    Select-Object LocalPort, State, OwningProcess | 
    Format-Table -AutoSize

# 检查 WSL 中的端口（TTS 服务在 WSL 中运行）
wsl bash -c "netstat -tuln | grep -E ':(5005|5008|9000)' || lsof -i :5005 -i :5008 -i :9000 2>/dev/null || echo 'No processes found'"

# 查看详细信息（包括进程名）
Get-NetTCPConnection -LocalPort 5005,5008,9000 -ErrorAction SilentlyContinue | 
    ForEach-Object {
        $proc = Get-Process -Id $_.OwningProcess -ErrorAction SilentlyContinue
        [PSCustomObject]@{
            Port = $_.LocalPort
            State = $_.State
            PID = $_.OwningProcess
            ProcessName = $proc.ProcessName
            Path = $proc.Path
        }
    } | Format-Table -AutoSize
```

### Linux/macOS

```bash
# 检查端口占用情况
lsof -i :5005 -i :5008 -i :9000

# 或者使用 netstat
netstat -tulpn | grep -E ':(5005|5008|9000)'
```

## 一键停止所有服务（Windows PowerShell）

```powershell
# 创建快速停止脚本
function Stop-LinguaServices {
    Write-Host "正在停止 Lingua 服务..." -ForegroundColor Yellow
    
    # 停止所有端口上的进程
    5005, 5008, 9000 | ForEach-Object {
        $port = $_
        $connections = Get-NetTCPConnection -LocalPort $port -ErrorAction SilentlyContinue
        foreach ($conn in $connections) {
            if ($conn.OwningProcess) {
                $proc = Get-Process -Id $conn.OwningProcess -ErrorAction SilentlyContinue
                if ($proc) {
                    Write-Host "  停止端口 $port 上的进程: $($proc.ProcessName) (PID: $($proc.Id))" -ForegroundColor Gray
                    Stop-Process -Id $proc.Id -Force -ErrorAction SilentlyContinue
                }
            }
        }
    }
    
    # 停止 WSL 中的 TTS 服务
    Write-Host "  停止 WSL 中的 TTS 服务..." -ForegroundColor Gray
    wsl bash -c "pkill -f piper_http_server || true" 2>$null
    
    Write-Host "所有服务已停止" -ForegroundColor Green
}

# 使用方式
Stop-LinguaServices
```

## 一键停止所有服务（Linux/macOS Bash）

```bash
#!/bin/bash
# 停止所有 Lingua 服务

echo "正在停止 Lingua 服务..."

# 停止所有端口上的进程
for port in 5005 5008 9000; do
    pids=$(lsof -ti:$port 2>/dev/null)
    if [ -n "$pids" ]; then
        echo "  停止端口 $port 上的进程..."
        echo "$pids" | xargs kill -9 2>/dev/null || true
    fi
done

# 停止相关进程
pkill -f "uvicorn.*nmt_service" 2>/dev/null || true
pkill -f piper_http_server 2>/dev/null || true
pkill -f core_engine 2>/dev/null || true

echo "所有服务已停止"
```

