# M2M100 实时翻译系统·短期优化实施清单

**版本：v1.0**  
**适用阶段：当前工程版已跑通 ASR → NMT（M2M100）→ TTS 的集成测试阶段**  

本清单用于指导在当前基础上，针对 _稳定性、可观测性、可维护性_ 做一轮“短期优化”，不改变整体架构，不大改代码，只做 **高性价比的小升级**。

---

## 一、目标概述

在不影响现有功能的前提下，完成以下目标：

1. **服务更稳**：NMT / TTS 异常时可以被检测、被优雅处理，而不是“卡死”。  
2. **性能可见**：端到端耗时、各模块耗时有基础日志可查。  
3. **部署更顺**：一键启动 / 集中配置，方便开发、演示和后续部署。  

---

## 二、短期必做项（优先级：高）

### 1. 健康检查与降级策略

**目标**：避免在 NMT / TTS 服务异常时，前端/用户感知为“卡死”或“无响应”。

**实施要点**：

1. **Engine 启动自检**  
   - 启动时自动调用：  
     - `GET NMT_BASE_URL/health`（或 `GET /v1/health`）  
     - `GET TTS_BASE_URL/health`（如果已实现）  
   - 若某服务不可用：  
     - 在日志中记录告警；  
     - 向前端返回明确错误状态（例如“翻译服务不可用，请稍后重试”）；  
     - 可以选择“降级模式”（只做 ASR，不做翻译/语音合成）。

2. **运行时错误处理与熔断（简单版本）**  
   - 在 NMT / TTS 调用处，若连续 N 次（例如 3 次）失败：  
     - 暂停调用该服务一段时间（例如 10–30 秒）；  
     - 在这段时间内直接返回“服务暂不可用”提示。  
   - 避免对挂掉的服务不停重试，拖慢整体响应。

---

### 2. 端到端耗时与质量的基础日志

**目标**：为后续优化与报告写作提供“有数据的依据”，而不是凭感觉。

**实施要点**：

1. **在 Engine 内添加定时点**  
   - 记录以下耗时：  
     - `asr_ms`：语音转文本耗时  
     - `nmt_ms`：文本翻译耗时（调用 Python NMT 服务）  
     - `tts_ms`：文本转语音耗时  
     - `total_ms`：整体请求耗时（S2S）  

2. **日志格式建议**（单行 JSON 方便后期分析）：
   ```jsonc
   {
     "ts": "2025-01-30T12:34:56Z",
     "id": "uuid-xxxx",
     "src_lang": "en",
     "tgt_lang": "zh",
     "asr_ms": 1234,
     "nmt_ms": 450,
     "tts_ms": 800,
     "total_ms": 2484,
     "ok": true
   }
   ```

3. **记录可疑翻译样本（简单规则）**  
   - 示例规则：  
     - 原文长度 > 20 字符，而译文长度 < 3 字符；  
     - 译文中非字母/非汉字字符比例 > 70%；  
   - 对于命中的条目：  
     - 额外输出一条日志，标记为 `suspect_translation: true`。  

> 说明：该阶段不做复杂的 NLP 质量评估，只用简单规则筛“明显不正常”的情况即可。

---

### 3. 一键启动脚本 & 集中配置

**目标**：简化开发/测试/演示操作，减少“这边起了，忘了那边”的情况。

**实施要点**：

1. **集中配置文件**  
   - 新增 `config.toml` / `config.yaml` / `config.json`（按项目习惯选择），包含：  
     - `nmt_service_url`：例如 `http://127.0.0.1:5008`  
     - `tts_service_url`：例如 `http://127.0.0.1:5002`  
     - `default_src_lang` / `default_tgt_lang`  
     - 可选：ASR 模型大小配置、端口号等  
   - Rust / Python 都从该配置中读取，不在代码中硬编码 URL / 端口。

2. **一键启动脚本（按平台选择）**  
   - Windows 推荐：`start_all.ps1`  
   - Linux / WSL 推荐：`start_all.sh`  
   - 内容示例：  
     1. 启动/检查 TTS 服务（Piper 等）；  
     2. 启动 Python NMT 服务（M2M100）；  
     3. 启动 Rust 主程序 / Demo；  
   - 可选：在脚本中加入简单的“端口检测”和“健康检查”。

3. **一键停止脚本**  
   - `stop_all.ps1` / `stop_all.sh`：按 PID 或进程名停止相关服务。  

> 说明：这一项的价值在于——对你自己、对未来 demo/演示极其友好，也是报告中“工程可维护性”的加分项。

---

## 三、建议实现的额外小优化（优先级：中）

这些不是“硬性要求”，但在当前阶段投入成本低、收益可观。

### 4. 文本后处理与简单兜底策略

**目标**：在不改变核心 NMT 模型的前提下，提升可读性与“观感稳定度”。

**建议内容**：

1. **基础清洗**  
   - 去除首尾多余空格  
   - 合并连续空格  
   - 避免出现明显重复的标点（如 `。。。。` → `。`）

2. **句号兜底**  
   - 若译文末尾无标点，可加一个简单句号（英文加 `.`，中文加 `。`），前提是不会影响已有标点。

3. **术语表 / 特殊名词表（简版）**  
   - 手工维护一个 `terms.json`：  
     ```jsonc
     {
       "Whisper": "Whisper",
       "Piper": "Piper",
       "M2M100": "M2M100"
     }
     ```  
   - 译文后做一次字符串替换，保证关键术语不被翻错。

---

### 5. 统一日志格式与级别

**目标**：让调试日志和产品日志更易读、易过滤。

**建议**：

1. 约定：  
   - `[ASR] ...`、`[NMT] ...`、`[TTS] ...` 作为前缀；  
   - 错误使用 `ERROR` 级别，警告使用 `WARN`，普通信息使用 `INFO`。  

2. 未来如接入 logging 库（如 `tracing` / `log`），可直接迁移。  

---

## 四、时间与工作量预估（供排期参考）

> 以 1 人 / 熟悉现有代码为基准的粗略估计：

1. **健康检查与降级策略**：约 0.5–1 天  
2. **端到端耗时与质量日志**：约 0.5 天  
3. **一键启动脚本 + 集中配置**：约 0.5–1 天  
4. **文本后处理与术语表（简版）**：约 0.5 天  
5. **统一日志格式与级别（基础版）**：约 0.5 天  

合计：约 **2–3 个工作日**，可作为一个短 Sprint 完成。

---

## 五、验收标准（简版）

短期优化完成后，应满足：

1. **服务稳定性**
   - NMT / TTS 服务异常时，前端不会“无响应”，日志中有清晰错误记录。  
2. **可观测性**
   - 任意一次端到端请求，可以从日志中查到 ASR / NMT / TTS / 总耗时。  
3. **可维护性**
   - 通过一份配置文件统一管理服务 URL / 端口；  
   - 通过一条脚本命令可启动全部服务做演示。  
4. **体验细节**
   - 输出文本无明显多余空格、怪异标点；  
   - 重要术语不会被频繁翻错（在术语表覆盖范围内）。  

---

本清单可直接作为 **“短期优化阶段任务规划”** 交给开发部门执行，也可附在项目报告中，作为工程实现与优化计划的一部分。