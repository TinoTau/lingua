# M2M100 集成测试改造方案  
（从 ONNX Decoder 切换到 Python NMT 服务）

**版本：v1.0**  
**适用范围：当前工程版实时翻译架构（Whisper → Python NMT → TTS）**

---

# 1. 改造背景与目标

旧集成测试使用 Rust + ONNX M2M100 Decoder（增量解码 + KV cache）。  
但当前系统已全面切换为：

> Whisper ASR → Python NMT 服务（HF M2M100）→ Piper/VITS TTS

因此，测试必须同步切换，否则永远无法验证真实工程路径。

---

# 2. 总体改造原则

1. **所有正式集成测试均必须走 Python NMT 服务**  
2. **不再调用 ONNX decoder / KV cache**（可保留代码，但不用于测试）  
3. **Rust 侧所有翻译调用统一用 `NmtClient` 实现类（HTTP 调 Python）**  
4. **确保端到端 S2S 测试覆盖 ASR→NMT→TTS 整条链路**  

---

# 3. 需要修改的内容（开发部门执行清单）

## 3.1 替换测试内部的翻译调用

### ❌ 旧方式（需要删除）
```rust
let mut translator = M2m100IncrementalTranslator::new(...);
let (logits, kv) = translator.decode_step(...);
```

### ✅ 新方式（必须使用）
```rust
let client = LocalM2m100HttpClient::new("http://127.0.0.1:5008");

let res = client.translate(&NmtTranslateRequest {
    src_lang: "en".to_string(),
    tgt_lang: "zh".to_string(),
    text: asr_text.clone(),
}).await?;
```

所有集成测试必须通过 HTTP 调用 Python NMT 服务。

---

## 3.2 从测试中移除所有 ONNX decoder 相关逻辑

需要停用：

- `M2m100IncrementalTranslator`
- `run_decoder_step`
- 所有 KV cache 结构及其检查
- 所有 decode logits 比对

处理方式：

- **删除测试** 或  
- **标记为 `#[ignore]`**（保留但不参与 CI）

---

## 3.3 更新 S2S 集成测试流程

集成测试应验证：

```
输入 wav → Whisper ASR → Python NMT → TTS → 输出 wav
```

示例（Rust 伪代码）：

```rust
#[tokio::test]
async fn test_s2s_pipeline() -> anyhow::Result<()> {

    // 1. ASR
    let asr_text = run_whisper("tests/audio/test.wav")?;
    assert!(!asr_text.is_empty());

    // 2. 翻译（经 Python 服务）
    let client = LocalM2m100HttpClient::new("http://127.0.0.1:5008");
    let translated = client.translate(&NmtTranslateRequest {
        src_lang: "en".into(),
        tgt_lang: "zh".into(),
        text: asr_text.clone(),
    }).await?;
    assert!(translated.text.len() > 0);

    // 3. TTS
    let wav_bytes = run_tts(&translated.text)?;
    assert!(wav_bytes.len() > 1000);

    Ok(())
}
```

---

# 4. 修改任务清单（可复制到 Jira）

| 序号 | 任务 | 状态 |
|-----|------|------|
| 1 | 移除旧 ONNX decoder 的测试调用 | ☐ |
| 2 | 新增 `LocalM2m100HttpClient` 在测试中使用 | ☐ |
| 3 | 所有集成测试切换为 Python NMT 服务 | ☐ |
| 4 | 旧 ONNX decoder 测试标记为 `#[ignore]` | ☐ |
| 5 | 重新构建 S2S 集成测试（ASR→NMT→TTS） | ☐ |
| 6 | 确保输出音频可播放、TTS 正常 | ☐ |
| 7 | 清理无用 KV cache / 旧接口 | ☐ |

---

# 5. 验收标准

满足以下条件后，集成测试视为“完全通过”：

### ✔ 1. 所有测试均使用 Python NMT 服务  
### ✔ 2. 不再调用任何 ONNX decoder / KV cache  
### ✔ 3. 端到端 S2S 流程可完整执行  
### ✔ 4. 输出音频可正常播放  
### ✔ 5. CI 所有测试全部通过  
### ✔ 6. M2M100 的旧重复/循环问题不再出现  

---

# 6. 结语

本方案的目标是让测试体系完全跟随新版工程架构，避免重复被过时的 ONNX decoder 阻塞。  
完成后，整个项目的稳定性、可维护性和工程可靠性将显著提升。

如果你需要下一份文档，比如：

- 《NmtClient 接口标准》
- 《Python NMT 服务端错误码规范》
- 《Rust 端 S2S 流程图》

告诉我即可。
