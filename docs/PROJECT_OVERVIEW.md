# Lingua 项目总览

**最后更新**: 2025-11-21  
**项目类型**: 语音转语音翻译系统（Speech-to-Speech Translation）  
**状态**: 🟢 核心功能完成，集成测试通过

---

## 目录

1. [项目概述](#1-项目概述)
2. [产品功能](#2-产品功能)
3. [系统架构](#3-系统架构)
4. [项目进度](#4-项目进度)
5. [当前问题](#5-当前问题)
6. [技术栈](#6-技术栈)
7. [下一步计划](#7-下一步计划)

---

## 1. 项目概述

### 1.1 项目目标

Lingua 是一个**语音转语音翻译系统**，旨在实现实时的多语言语音翻译功能。系统支持将一种语言的语音输入转换为另一种语言的语音输出，实现跨语言的自然交流。

### 1.2 核心价值

- **实时翻译**: 支持流式处理，低延迟
- **多语言支持**: 支持中文、英文等多种语言
- **本地部署**: 所有处理在本地完成，保护隐私
- **模块化设计**: 各组件可独立替换和升级

---

## 2. 产品功能

### 2.1 核心功能

#### ✅ 英文 → 中文翻译
- **ASR（语音识别）**: 识别英文语音，转换为文本
- **NMT（机器翻译）**: 将英文文本翻译为中文文本
- **TTS（语音合成）**: 将中文文本合成为中文语音

#### ✅ 中文 → 英文翻译
- **ASR（语音识别）**: 识别中文语音，转换为文本
- **NMT（机器翻译）**: 将中文文本翻译为英文文本
- **TTS（语音合成）**: 将英文文本合成为英文语音

### 2.2 辅助功能

#### ⚠️ Emotion（情感分析）
- **状态**: 部分完成
- **功能**: 分析文本情感，用于个性化翻译
- **实现**: XLM-R ONNX 模型（存在 IR 版本兼容性问题）

#### ⚠️ Persona（个性化适配）
- **状态**: 部分完成
- **功能**: 根据用户偏好和文化背景调整翻译风格
- **实现**: 基于规则的文本转换

### 2.3 系统特性

- **流式处理**: 支持实时音频流处理
- **增量翻译**: NMT 支持增量解码，提高效率
- **KV Cache 优化**: 减少重复计算，提升性能
- **模块化架构**: 各组件可独立测试和替换

---

## 3. 系统架构

### 3.1 核心流程

```
输入语音 
  ↓
VAD (语音活动检测)
  ↓
ASR (语音识别) → 文本
  ↓
Emotion (情感分析) → 情感标签
  ↓
Persona (个性化适配) → 调整后文本
  ↓
NMT (机器翻译) → 翻译文本
  ↓
TTS (语音合成) → 输出语音
```

### 3.2 模块架构

#### 3.2.1 CoreEngine（核心引擎）

**位置**: `core/engine/src/bootstrap.rs`

**职责**:
- 统一编排各个模块
- 通过 EventBus 发布事件
- 管理模块生命周期

**组件**:
- `EventBus`: 事件总线，用于模块间通信
- `VAD`: 语音活动检测
- `ASR`: 语音识别
- `NMT`: 机器翻译
- `Emotion`: 情感分析
- `Persona`: 个性化适配
- `TTS`: 语音合成
- `ConfigManager`: 配置管理
- `CacheManager`: 缓存管理
- `TelemetrySink`: 遥测数据收集

#### 3.2.2 ASR（语音识别）

**实现**: Whisper ASR  
**位置**: `core/engine/src/asr_whisper/`  
**状态**: ✅ 已完成

**功能**:
- 流式语音识别
- 自动语言检测
- 多语言支持（99 种语言）

**模型**:
- `whisper-base` (147 MB)
- 位置: `core/engine/models/asr/whisper-base/`

#### 3.2.3 NMT（神经机器翻译）

**实现**: Marian NMT (ONNX)  
**位置**: `core/engine/src/nmt_incremental/`  
**状态**: ✅ 已完成

**功能**:
- 增量翻译
- KV Cache 优化
- 支持多语言对

**模型**:
- `marian-en-zh`: 英文→中文（✅ 正常工作）
- `marian-zh-en`: 中文→英文（✅ 正常工作，IR 7 版本）

**技术细节**:
- 使用 ONNX Runtime 1.16.3
- 支持 IR ≤ 9 的模型
- 分离的 Encoder/Decoder 架构

#### 3.2.4 TTS（文本转语音）

**实现**: 
- **英文**: MMS TTS (VITS) ✅
- **中文**: Piper TTS (WSL2 HTTP 服务) ✅

**位置**: `core/engine/src/tts_streaming/`  
**状态**: ✅ 已完成

**英文 TTS**:
- 模型: MMS TTS (VITS)
- 状态: ✅ 正常工作

**中文 TTS**:
- 模型: Piper TTS (`zh_CN-huayan-medium`)
- 部署: WSL2 + FastAPI HTTP 服务
- 服务地址: `http://127.0.0.1:5005/tts`
- 状态: ✅ 正常工作

#### 3.2.5 Emotion（情感分析）

**实现**: XLM-R ONNX  
**位置**: `core/engine/src/emotion_adapter/`  
**状态**: ⚠️ 部分完成

**问题**:
- 模型 IR 版本兼容性问题
- 需要 IR ≤ 9，但部分模型为 IR 10

#### 3.2.6 Persona（个性化适配）

**实现**: 基于规则的文本转换  
**位置**: `core/engine/src/persona_adapter/`  
**状态**: ⚠️ 部分完成

**功能**:
- 根据文化背景调整文本
- 支持专业/非正式风格转换

---

## 4. 项目进度

### 4.1 总体进度

| 模块 | 完成度 | 状态 | 测试状态 |
|------|--------|------|----------|
| ASR (Whisper) | 95% | ✅ 基本完成 | ✅ 测试通过 |
| NMT (Marian) | 95% | ✅ 基本完成 | ✅ 测试通过 |
| TTS (英文) | 95% | ✅ 基本完成 | ✅ 测试通过 |
| TTS (中文) | 95% | ✅ 基本完成 | ✅ 测试通过 |
| S2S 集成 | 90% | ✅ 基本完成 | ✅ 集成测试通过 |
| Emotion | 30% | ⚠️ 部分完成 | ❌ 无测试 |
| Persona | 30% | ⚠️ 部分完成 | ❌ 无测试 |
| 系统集成 | 80% | ✅ 基本完成 | ✅ 集成测试通过 |

**总体完成度**: ~75%

### 4.2 详细进度

#### ✅ 已完成

1. **ASR 模块**
   - ✅ Whisper 模型集成
   - ✅ 流式识别实现
   - ✅ 多语言支持
   - ✅ 测试通过

2. **NMT 模块**
   - ✅ Marian 模型集成（en-zh 和 zh-en）
   - ✅ Encoder/Decoder 实现
   - ✅ KV Cache 优化
   - ✅ 增量翻译
   - ✅ 测试通过（双向翻译）

3. **TTS 模块**
   - ✅ 英文 TTS (MMS VITS)
   - ✅ 中文 TTS (Piper HTTP)
   - ✅ 流式合成
   - ✅ 测试通过

4. **系统集成**
   - ✅ CoreEngine 架构
   - ✅ EventBus 实现
   - ✅ 模块化设计
   - ✅ 完整端到端测试通过
   - ✅ S2S 集成测试通过（en-zh 和 zh-en）

#### ⚠️ 进行中

1. **NMT 模块优化**
   - ✅ 模型导出（IR 7）
   - ✅ 模型加载
   - ✅ 运行时正常
   - ⚠️ 性能优化（KV Cache）

2. **Emotion 模块**
   - ✅ Trait 定义
   - ✅ 模型文件存在
   - ❌ IR 版本兼容性问题
   - ❌ 未完成实现

3. **Persona 模块**
   - ✅ Trait 定义
   - ⚠️ 部分规则实现
   - ❌ 未完成测试

#### ❌ 未开始

1. **WASM 构建**
   - ❌ wasm32 目标配置
   - ❌ WASM 绑定
   - ❌ 浏览器集成

2. **Chrome 扩展**
   - ❌ 插件集成
   - ❌ 端到端测试

---

## 5. 当前问题

### 5.1 关键问题 ✅ 已解决

#### ✅ 问题 1: S2S 集成测试配置错误（已解决）

**严重程度**: ✅ 已解决

**问题描述**:
- 集成测试脚本使用了错误的文本和模型方向
- TTS 使用了 `source_text` 而不是 `target_text`
- NMT 模型方向与 ASR 输出语言不匹配

**解决方案**:
- 修复 TTS 输入：使用 `target_text`（翻译结果）
- 添加 `--direction` 参数：支持选择翻译方向（en-zh 或 zh-en）
- 自动配置：根据方向自动选择正确的 NMT 模型和 TTS 配置

**状态**: ✅ 已修复，集成测试通过

**详细报告**: 
- 问题报告: `docs/architecture/integration_test_issue_summary.md`
- 测试通过报告: `docs/architecture/S2S_INTEGRATION_TEST_PASSED.md`

### 5.2 次要问题 ⚠️

#### 问题 2: Emotion 模块 IR 版本兼容性

**严重程度**: ⚠️ 中 - 不影响核心功能

**问题描述**:
- XLM-R 模型存在 IR 版本兼容性问题
- 需要 IR ≤ 9，但部分模型为 IR 10

**影响**:
- Emotion 功能不可用
- 不影响核心翻译功能

#### 问题 3: Persona 模块未完成

**严重程度**: ⚠️ 低 - 不影响核心功能

**问题描述**:
- Persona 模块仅部分实现
- 缺少完整测试

**影响**:
- 个性化功能受限
- 不影响核心翻译功能

### 5.3 技术债务

1. **ONNX Runtime 版本锁定**
   - 当前使用 ort 1.16.3（仅支持 IR ≤ 9）
   - 限制了可用的模型版本

2. **Windows 链接器问题**
   - 已解决（通过修改 esaxx-rs）
   - 但需要维护本地补丁

3. **WSL2 依赖**
   - 中文 TTS 依赖 WSL2 环境
   - 增加了部署复杂度

---

## 6. 技术栈

### 6.1 编程语言

- **Rust**: 核心引擎实现
- **Python**: 模型导出脚本、测试工具
- **TypeScript/JavaScript**: 客户端集成（计划中）

### 6.2 核心依赖

- **Tokio**: 异步运行时
- **ONNX Runtime**: 1.16.3（模型推理）
- **whisper-rs**: Whisper ASR 集成
- **ndarray**: 数值计算
- **serde**: 序列化/反序列化
- **reqwest**: HTTP 客户端（Piper TTS）

### 6.3 模型技术

- **ASR**: Whisper (OpenAI)
- **NMT**: Marian NMT (Helsinki-NLP)
- **TTS**: 
  - 英文: MMS TTS (VITS)
  - 中文: Piper TTS
- **Emotion**: XLM-R (Facebook)

### 6.4 部署环境

- **开发环境**: Windows 10/11
- **运行时**: 
  - Windows (主系统)
  - WSL2 (Piper TTS 服务)
- **目标平台**: 
  - 本地部署（当前）
  - WASM/浏览器（计划中）

---

## 7. 下一步计划

### 7.1 短期目标（1-2 周）

#### 优先级 P0（阻塞）

1. **修复 Marian NMT 运行时错误**
   - 深入调试访问违规错误
   - 对比工作模型与新模型的差异
   - 修复或重新导出模型
   - **预计时间**: 1-3 天

2. **完成端到端测试**
   - 修复 NMT 问题后
   - 进行完整的 S2S 流程测试
   - 验证双向翻译功能
   - **预计时间**: 1 天

#### 优先级 P1（重要）

3. **完善 Emotion 模块**
   - 解决 IR 版本兼容性问题
   - 完成实现和测试
   - **预计时间**: 2-3 天

4. **完善 Persona 模块**
   - 完成规则实现
   - 添加测试
   - **预计时间**: 1-2 天

### 7.2 中期目标（1 个月）

5. **工程化改进**
   - 创建安装器脚本
   - 实现服务自动启动
   - 优化性能和稳定性
   - **预计时间**: 1 周

6. **文档完善**
   - API 文档
   - 用户指南
   - 开发者文档
   - **预计时间**: 3-5 天

### 7.3 长期目标（3 个月+）

7. **WASM 构建**
   - 配置 wasm32 目标
   - 实现 WASM 绑定
   - 浏览器集成测试
   - **预计时间**: 2-3 周

8. **Chrome 扩展**
   - 插件开发
   - 端到端测试
   - 发布准备
   - **预计时间**: 2-3 周

---

## 8. 相关文档

### 8.1 架构文档

- `core/engine/docs/SYSTEM_ARCHITECTURE_OVERVIEW.md` - 系统架构总览
- `docs/architecture/` - 架构相关文档

### 8.2 进度文档

- `PROJECT_PROGRESS.md` - 详细进度报告
- `core/engine/docs/SPEECH_TO_SPEECH_TRANSLATION_STATUS.md` - S2S 系统状态

### 8.3 问题文档

- `docs/architecture/MARIAN_IR7_MODEL_RUNTIME_ISSUE_REPORT.md` - NMT 运行时问题报告
- `docs/architecture/S2S_INTEGRATION_ISSUE_REPORT.md` - S2S 集成问题报告

### 8.4 实现文档

- `docs/architecture/PIPER_TTS_IMPLEMENTATION_COMPLETE.md` - Piper TTS 实现文档
- `docs/architecture/WSL2_PIPER_IMPLEMENTATION_SUMMARY.md` - WSL2 部署文档

---

## 9. 项目统计

### 9.1 代码统计

- **核心引擎**: ~15,000 行 Rust 代码
- **测试代码**: ~2,000 行
- **脚本工具**: ~1,000 行 Python 代码

### 9.2 模型统计

- **ASR 模型**: 1 个（Whisper base）
- **NMT 模型**: 2 个（marian-en-zh, marian-zh-en）
- **TTS 模型**: 2 个（MMS VITS, Piper）
- **Emotion 模型**: 1 个（XLM-R，部分可用）

### 9.3 测试覆盖

- **单元测试**: ~30 个
- **集成测试**: ~10 个
- **端到端测试**: ~5 个

---

## 10. 联系方式

### 10.1 项目信息

- **项目名称**: Lingua
- **项目类型**: 语音转语音翻译系统
- **开发状态**: 活跃开发中

### 10.2 文档维护

- **最后更新**: 2025-11-21
- **维护者**: 开发团队
- **更新频率**: 根据项目进展更新

---

**文档版本**: 1.0  
**最后更新**: 2025-11-21  
**状态**: 🟡 进行中

