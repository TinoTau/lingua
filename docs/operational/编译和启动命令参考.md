# Lingua ç¼–è¯‘å’Œå¯åŠ¨å‘½ä»¤å‚è€ƒ

**æœ€åæ›´æ–°**: 2025-11-27

æœ¬æ–‡æ¡£æ•´ç†äº† Lingua é¡¹ç›®çš„æ‰€æœ‰ç¼–è¯‘å’Œå¯åŠ¨å‘½ä»¤ï¼Œæ–¹ä¾¿å¿«é€ŸæŸ¥é˜…ã€‚

---

## ğŸ“‹ ç›®å½•

1. [ä¸€é”®å¯åŠ¨](#ä¸€é”®å¯åŠ¨)
2. [æ‰‹åŠ¨å¯åŠ¨æœåŠ¡](#æ‰‹åŠ¨å¯åŠ¨æœåŠ¡)
3. [ç¼–è¯‘å‘½ä»¤](#ç¼–è¯‘å‘½ä»¤)
4. [æœåŠ¡ç®¡ç†](#æœåŠ¡ç®¡ç†)
5. [æµ‹è¯•å‘½ä»¤](#æµ‹è¯•å‘½ä»¤)
6. [GPU åŠ é€Ÿé…ç½®](#gpu-åŠ é€Ÿé…ç½®)

---

## ğŸš€ ä¸€é”®å¯åŠ¨

### Windows

```powershell
# åœ¨é¡¹ç›®æ ¹ç›®å½•æ‰§è¡Œ
.\start_lingua_core.ps1
```

**åŠŸèƒ½**ï¼š
- è‡ªåŠ¨å¯åŠ¨ NMT æœåŠ¡ï¼ˆç«¯å£ 5008ï¼‰
- è‡ªåŠ¨å¯åŠ¨ TTS æœåŠ¡ï¼ˆWSL ä¸­çš„ Piperï¼Œç«¯å£ 5005ï¼‰
- è‡ªåŠ¨å¯åŠ¨ CoreEngine æœåŠ¡ï¼ˆç«¯å£ 9000ï¼‰
- è‡ªåŠ¨å¯åŠ¨ Web UI æœåŠ¡å™¨ï¼ˆç«¯å£ 8080ï¼‰
- è‡ªåŠ¨é…ç½® WSL ç«¯å£è½¬å‘
- è‡ªåŠ¨è¿›è¡Œå¥åº·æ£€æŸ¥

**è®¿é—®åœ°å€**ï¼š
- Web UI: http://localhost:8080
- CoreEngine API: http://127.0.0.1:9000
- NMT Service: http://127.0.0.1:5008
- TTS Service: http://127.0.0.1:5005

### Linux / macOS

```bash
# åœ¨é¡¹ç›®æ ¹ç›®å½•æ‰§è¡Œ
bash start_lingua_core.sh
```

---

## ğŸ”§ æ‰‹åŠ¨å¯åŠ¨æœåŠ¡

### 1. å¯åŠ¨ NMT æœåŠ¡ï¼ˆPython M2M100ï¼‰

```powershell
# Windows PowerShell
cd services\nmt_m2m100
python -m venv venv
.\venv\Scripts\Activate.ps1
pip install -r requirements.txt
uvicorn nmt_service:app --host 127.0.0.1 --port 5008
```

```bash
# Linux / macOS / WSL
cd services/nmt_m2m100
python3 -m venv venv
source venv/bin/activate
pip install -r requirements.txt
uvicorn nmt_service:app --host 127.0.0.1 --port 5008
```

**å¥åº·æ£€æŸ¥**ï¼š
```bash
curl http://127.0.0.1:5008/health
```

### 2. å¯åŠ¨ TTS æœåŠ¡ï¼ˆPiperï¼Œåœ¨ WSL ä¸­ï¼‰

```bash
# åœ¨ WSL ä¸­æ‰§è¡Œ
cd /mnt/d/Programs/github/lingua/scripts/wsl2_piper
bash start_piper_service.sh
```

**æˆ–æ‰‹åŠ¨å¯åŠ¨**ï¼š
```bash
# åœ¨ WSL ä¸­æ‰§è¡Œ
cd /path/to/piper
./piper --model /path/to/model.onnx --host 0.0.0.0 --port 5005
```

**å¥åº·æ£€æŸ¥**ï¼š
```bash
# åœ¨ Windows PowerShell ä¸­
curl http://127.0.0.1:5005/health

# æˆ–åœ¨ WSL ä¸­
curl http://localhost:5005/health
```

**é…ç½®ç«¯å£è½¬å‘**ï¼ˆWindows â†’ WSLï¼‰ï¼š
```powershell
# ä»¥ç®¡ç†å‘˜èº«ä»½è¿è¡Œ PowerShell
# è·å– WSL IP
$wslIp = (wsl bash -c "hostname -I | awk '{print `$1}'").Trim()

# åˆ é™¤æ—§è§„åˆ™ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
netsh interface portproxy delete v4tov4 listenport=5005 listenaddress=127.0.0.1

# æ·»åŠ æ–°è§„åˆ™
netsh interface portproxy add v4tov4 listenport=5005 listenaddress=127.0.0.1 connectport=5005 connectaddress=$wslIp
```

### 3. å¯åŠ¨ CoreEngine æœåŠ¡

```powershell
# Windows PowerShell
cd core\engine
cargo build --release --bin core_engine
.\target\release\core_engine.exe --config ..\..\lingua_core_config.toml
```

```bash
# Linux / macOS
cd core/engine
cargo build --release --bin core_engine
./target/release/core_engine --config ../../lingua_core_config.toml
```

**å¥åº·æ£€æŸ¥**ï¼š
```bash
curl http://127.0.0.1:9000/health
```

### 4. å¯åŠ¨ Web UI æœåŠ¡å™¨

```powershell
# Windows PowerShell
cd clients\web_pwa
python -m http.server 8080
```

```bash
# Linux / macOS
cd clients/web_pwa
python3 -m http.server 8080
```

**æˆ–ä½¿ç”¨ npx**ï¼š
```bash
npx http-server clients/web_pwa -p 8080
```

---

## ğŸ”¨ ç¼–è¯‘å‘½ä»¤

### CoreEngineï¼ˆRustï¼‰

#### å¼€å‘æ¨¡å¼ç¼–è¯‘

```powershell
# Windows PowerShell
cd core\engine
cargo build
```

```bash
# Linux / macOS
cd core/engine
cargo build
```

#### å‘å¸ƒæ¨¡å¼ç¼–è¯‘

```powershell
# Windows PowerShell
cd core\engine
cargo build --release --bin core_engine
```

```bash
# Linux / macOS
cd core/engine
cargo build --release --bin core_engine
```

#### å¯ç”¨ GPU æ”¯æŒï¼ˆCUDAï¼‰

1. ä¿®æ”¹ `core/engine/Cargo.toml`ï¼š
```toml
[dependencies]
whisper-rs = { version = "0.15.1", features = ["cuda"] }
```

2. é‡æ–°ç¼–è¯‘ï¼š
```powershell
cd core\engine
cargo clean
cargo build --release --bin core_engine
```

**æ³¨æ„**ï¼šéœ€è¦å…ˆå®‰è£… CUDA Toolkitï¼Œè¯¦è§ [GPU å¯ç”¨æŒ‡å—](../GPU_å¯ç”¨æŒ‡å—.md)

### æ¸…ç†ç¼–è¯‘äº§ç‰©

```powershell
# Windows PowerShell
cd core\engine
cargo clean
```

```bash
# Linux / macOS
cd core/engine
cargo clean
```

---

## ğŸ› ï¸ æœåŠ¡ç®¡ç†

### åœæ­¢æ‰€æœ‰æœåŠ¡

#### Windows PowerShell

```powershell
# åœæ­¢ CoreEngine
Get-Process -Name "core_engine" -ErrorAction SilentlyContinue | Stop-Process -Force

# åœæ­¢ NMT æœåŠ¡ï¼ˆé€šè¿‡ç«¯å£ï¼‰
$nmtConnections = Get-NetTCPConnection -LocalPort 5008 -ErrorAction SilentlyContinue
foreach ($conn in $nmtConnections) {
    if ($conn.OwningProcess) {
        $proc = Get-Process -Id $conn.OwningProcess -ErrorAction SilentlyContinue
        if ($proc -and ($proc.ProcessName -eq "python" -or $proc.ProcessName -eq "pythonw")) {
            Stop-Process -Id $proc.Id -Force
        }
    }
}

# åœæ­¢ TTS æœåŠ¡ï¼ˆé€šè¿‡ç«¯å£ï¼‰
$ttsConnections = Get-NetTCPConnection -LocalPort 5005 -ErrorAction SilentlyContinue
foreach ($conn in $ttsConnections) {
    if ($conn.OwningProcess) {
        $proc = Get-Process -Id $conn.OwningProcess -ErrorAction SilentlyContinue
        if ($proc) {
            Stop-Process -Id $proc.Id -Force
        }
    }
}

# åœæ­¢ Web UI æœåŠ¡å™¨ï¼ˆé€šè¿‡ç«¯å£ï¼‰
$webConnections = Get-NetTCPConnection -LocalPort 8080 -ErrorAction SilentlyContinue
foreach ($conn in $webConnections) {
    if ($conn.OwningProcess) {
        $proc = Get-Process -Id $conn.OwningProcess -ErrorAction SilentlyContinue
        if ($proc) {
            Stop-Process -Id $proc.Id -Force
        }
    }
}
```

#### Linux / macOS

```bash
# åœæ­¢ CoreEngine
pkill -f core_engine

# åœæ­¢ NMT æœåŠ¡
pkill -f "uvicorn nmt_service"

# åœæ­¢ TTS æœåŠ¡ï¼ˆåœ¨ WSL ä¸­ï¼‰
wsl pkill -f piper

# åœæ­¢ Web UI æœåŠ¡å™¨
pkill -f "http.server"
```

#### å¿«é€Ÿåœæ­¢ï¼ˆWindowsï¼‰

```powershell
# åœæ­¢ç«¯å£ 5005, 5008, 9000, 8080 ä¸Šçš„æ‰€æœ‰è¿›ç¨‹
$ports = @(5005, 5008, 9000, 8080)
foreach ($port in $ports) {
    $connections = Get-NetTCPConnection -LocalPort $port -ErrorAction SilentlyContinue
    foreach ($conn in $connections) {
        if ($conn.OwningProcess) {
            Stop-Process -Id $conn.OwningProcess -Force -ErrorAction SilentlyContinue
        }
    }
}
```

### æ£€æŸ¥æœåŠ¡çŠ¶æ€

```powershell
# Windows PowerShell
# æ£€æŸ¥ç«¯å£å ç”¨
Get-NetTCPConnection -LocalPort 5005,5008,9000,8080 -ErrorAction SilentlyContinue | Select-Object LocalPort, State, OwningProcess
```

```bash
# Linux / macOS
# æ£€æŸ¥ç«¯å£å ç”¨
netstat -tuln | grep -E ":(5005|5008|9000|8080)"
# æˆ–
ss -tuln | grep -E ":(5005|5008|9000|8080)"
```

---

## ğŸ§ª æµ‹è¯•å‘½ä»¤

### è¿è¡Œå•å…ƒæµ‹è¯•

```powershell
# Windows PowerShell
cd core\engine
cargo test
```

```bash
# Linux / macOS
cd core/engine
cargo test
```

### è¿è¡Œç‰¹å®šæµ‹è¯•

```powershell
# Windows PowerShell
cd core\engine
# è¿è¡Œæ–‡æœ¬åˆ†å‰²æµ‹è¯•
cargo test --lib text_segmentation::tests

# è¿è¡Œé›†æˆæµ‹è¯•
cargo test --test s2s_pipeline_integration_test
```

```bash
# Linux / macOS
cd core/engine
cargo test --lib text_segmentation::tests
cargo test --test s2s_pipeline_integration_test
```

### è¿è¡Œæµ‹è¯•å¹¶æ˜¾ç¤ºè¾“å‡º

```powershell
# Windows PowerShell
cd core\engine
cargo test -- --nocapture
```

```bash
# Linux / macOS
cd core/engine
cargo test -- --nocapture
```

### API æµ‹è¯•

#### æµ‹è¯• CoreEngine å¥åº·æ£€æŸ¥

```bash
curl http://127.0.0.1:9000/health
```

#### æµ‹è¯• NMT æœåŠ¡

```bash
curl -X POST http://127.0.0.1:5008/v1/translate \
  -H "Content-Type: application/json" \
  -d '{
    "src_lang": "zh",
    "tgt_lang": "en",
    "text": "ä½ å¥½ï¼Œä¸–ç•Œ"
  }'
```

#### æµ‹è¯• TTS æœåŠ¡

```bash
curl -X POST http://127.0.0.1:5005/tts \
  -H "Content-Type: application/json" \
  -d '{
    "text": "Hello, world",
    "voice": "en_US-lessac-medium",
    "locale": "en"
  }' \
  --output test_output.wav
```

#### æµ‹è¯• S2S API

```bash
# éœ€è¦å…ˆå‡†å¤‡ base64 ç¼–ç çš„ WAV éŸ³é¢‘
curl -X POST http://127.0.0.1:9000/s2s \
  -H "Content-Type: application/json" \
  -d '{
    "audio": "<base64_encoded_wav>",
    "src_lang": "zh",
    "tgt_lang": "en"
  }'
```

---

## ğŸ® GPU åŠ é€Ÿé…ç½®

### æ£€æŸ¥ GPU æ˜¯å¦å¯ç”¨

```powershell
# Windows PowerShell
nvidia-smi
```

### å¯ç”¨ Whisper ASR GPU åŠ é€Ÿ

1. å®‰è£… CUDA Toolkitï¼ˆå¦‚æœæœªå®‰è£…ï¼‰
   - ä¸‹è½½åœ°å€ï¼šhttps://developer.nvidia.com/cuda-downloads

2. ä¿®æ”¹ `core/engine/Cargo.toml`ï¼š
```toml
[dependencies]
whisper-rs = { version = "0.15.1", features = ["cuda"] }
```

3. é‡æ–°ç¼–è¯‘ï¼š
```powershell
cd core\engine
cargo clean
cargo build --release --bin core_engine
```

4. éªŒè¯ GPU æ˜¯å¦å¯ç”¨ï¼š
   - å¯åŠ¨ CoreEngine åï¼ŒæŸ¥çœ‹æ—¥å¿—ä¸­æ˜¯å¦æœ‰ `whisper_backend_init_gpu: using GPU`

### å¯ç”¨ NMT æœåŠ¡ GPU åŠ é€Ÿ

NMT æœåŠ¡ï¼ˆPythonï¼‰ä¼šè‡ªåŠ¨æ£€æµ‹å¹¶ä½¿ç”¨ GPUï¼ˆå¦‚æœå¯ç”¨ï¼‰ã€‚ç¡®ä¿å·²å®‰è£… `torch` çš„ CUDA ç‰ˆæœ¬ï¼š

```bash
# åœ¨ NMT æœåŠ¡è™šæ‹Ÿç¯å¢ƒä¸­
pip install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cu118
```

### å¯ç”¨ TTS æœåŠ¡ GPU åŠ é€Ÿ

Piper TTS åœ¨ WSL ä¸­è¿è¡Œï¼Œå¦‚éœ€ GPU åŠ é€Ÿï¼Œéœ€è¦ï¼š
1. åœ¨ WSL ä¸­å®‰è£… CUDA
2. ä½¿ç”¨æ”¯æŒ GPU çš„ ONNX Runtime

**è¯¦ç»†æ­¥éª¤**ï¼šå‚è€ƒ [GPU å¯ç”¨æŒ‡å—](../GPU_å¯ç”¨æŒ‡å—.md)

---

## ğŸ“ ç¯å¢ƒå˜é‡

### NMT æœåŠ¡

```powershell
# Windows PowerShell
$env:HF_TOKEN="your_huggingface_token_here"
```

```bash
# Linux / macOS
export HF_TOKEN="your_huggingface_token_here"
```

### CoreEngine

```powershell
# Windows PowerShell
$env:RUST_LOG="debug"  # å¯ç”¨è°ƒè¯•æ—¥å¿—
```

```bash
# Linux / macOS
export RUST_LOG=debug
```

---

## ğŸ” æ•…éšœæ’æŸ¥

### æœåŠ¡æ— æ³•å¯åŠ¨

1. **æ£€æŸ¥ç«¯å£æ˜¯å¦è¢«å ç”¨**ï¼š
```powershell
# Windows PowerShell
Get-NetTCPConnection -LocalPort 5005,5008,9000,8080
```

2. **æ£€æŸ¥ä¾èµ–æ˜¯å¦å®‰è£…**ï¼š
```powershell
# Windows PowerShell
# æ£€æŸ¥ Python
python --version

# æ£€æŸ¥ Rust
cargo --version

# æ£€æŸ¥ Node.jsï¼ˆå¯é€‰ï¼‰
node --version
```

### ç¼–è¯‘é”™è¯¯

1. **æ¸…ç†å¹¶é‡æ–°ç¼–è¯‘**ï¼š
```powershell
cd core\engine
cargo clean
cargo build --release
```

2. **æ›´æ–°ä¾èµ–**ï¼š
```powershell
cd core\engine
cargo update
```

### WSL ç«¯å£è½¬å‘é—®é¢˜

1. **æ£€æŸ¥ WSL IP**ï¼š
```powershell
wsl bash -c "hostname -I | awk '{print `$1}'"
```

2. **é‡æ–°é…ç½®ç«¯å£è½¬å‘**ï¼š
```powershell
# ä»¥ç®¡ç†å‘˜èº«ä»½è¿è¡Œ
$wslIp = (wsl bash -c "hostname -I | awk '{print `$1}'").Trim()
netsh interface portproxy delete v4tov4 listenport=5005 listenaddress=127.0.0.1
netsh interface portproxy add v4tov4 listenport=5005 listenaddress=127.0.0.1 connectport=5005 connectaddress=$wslIp
```

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [GPU å¯ç”¨æŒ‡å—](../GPU_å¯ç”¨æŒ‡å—.md)
- [æ‰‹åŠ¨åœæ­¢æœåŠ¡å‘½ä»¤](../æ‰‹åŠ¨åœæ­¢æœåŠ¡å‘½ä»¤.md)
- [Lingua Core Runtime ä¸€é”®å¯åŠ¨ä¸æœåŠ¡è®¾è®¡è¯´æ˜](../product/Lingua_Core_Runtime_ä¸€é”®å¯åŠ¨ä¸æœåŠ¡è®¾è®¡è¯´æ˜.md)

---

**æœ€åæ›´æ–°**: 2025-11-27

