# ONNX Runtime 升级建议

**日期**: 2025-11-21  
**状态**: ✅ 建议不升级，使用替代方案

## 分析结论

### 关键发现

1. **模型 IR 版本分布**:
   - ✅ `marian-en-zh`: IR 9, Opset 18（兼容当前 ort 1.16.3）
   - ❌ `marian-zh-en`: IR 10, Opset 18（需要升级 ort）
   - ❌ 其他所有模型: IR 10, Opset 18

2. **ort 依赖范围**:
   - **NMT (Marian ONNX)**: 所有翻译功能
   - **Emotion (XLM-R)**: 情感分析功能（当前无法加载，也是 IR 10）
   - **TTS (FastSpeech2, VITS)**: 英文文本转语音功能

3. **升级风险**:
   - ⚠️ 需要全面测试所有功能
   - ⚠️ 可能有 API 变化
   - ⚠️ 可能影响现有 IR 9 模型

## 推荐方案：不升级 ort，使用 `marian-en-zh` 进行测试

### 理由

1. **风险最低**: 无需修改任何依赖或模型
2. **快速验证**: 可以立即验证 S2S 流程
3. **不影响现有功能**: 所有现有功能继续正常工作
4. **后续可扩展**: 等 ort 升级方案验证后再测试中文→英文流程

### 实施步骤

1. **修改测试使用 `marian-en-zh`**:
   - 修改 `test_s2s_full_simple.rs` 使用 `marian-en-zh`
   - 调整测试流程为：英文语音 → 英文文本 → 中文文本 → 中文语音

2. **验证 S2S 流程**:
   - 使用英文输入音频
   - 验证完整流程：ASR → NMT → TTS

3. **后续扩展**:
   - 如果需要中文→英文流程，再考虑：
     - 升级 ort（需要全面测试）
     - 或重新导出 IR 9 版本的 `marian-zh-en` 模型

## 如果必须升级 ort

### 前提条件

1. **全面测试计划**:
   - 测试所有 NMT 功能（使用 `marian-en-zh`）
   - 测试 Emotion 功能（如果模型可用）
   - 测试 TTS 功能（FastSpeech2, VITS）

2. **API 兼容性检查**:
   - 检查 `ort` 最新版本的 API 变化
   - 更新所有使用 `ort` 的代码

3. **回滚方案**:
   - 保留当前版本
   - 准备快速回滚

### 升级步骤

1. 检查 `ort` 最新版本和支持的 IR 版本
2. 在测试分支升级 `ort`
3. 运行所有测试
4. 修复 API 变化
5. 全面测试所有功能
6. 如果通过，合并到主分支

## 总结

**当前建议**: **不升级 ort**，使用 `marian-en-zh` 进行测试

**原因**:
- 风险太高（影响三个核心模块）
- 有替代方案（使用 `marian-en-zh`）
- 可以验证 S2S 流程

**后续考虑**:
- 如果需要中文→英文流程，再评估升级 ort 的可行性
- 或考虑重新导出 IR 9 版本的 `marian-zh-en` 模型

