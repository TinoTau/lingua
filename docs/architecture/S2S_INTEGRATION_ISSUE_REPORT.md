# S2S 完整集成测试问题报告

**报告日期**: 2025-11-21  
**报告人**: 开发团队  
**优先级**: P0  
**状态**: 🔴 阻塞中

---

## 执行摘要

在进行完整 S2S（语音转语音）集成测试时，遇到了两个关键问题：

1. ✅ **已解决**: Windows 链接器问题（whisper-rs-sys 和 esaxx-rs 运行时库不匹配）
2. 🔴 **待解决**: Marian NMT 模型 ONNX IR 版本兼容性问题（IR 10 vs IR 9）

当前状态：链接器问题已解决，但 IR 版本问题阻塞了完整 S2S 测试的进行。

---

## 1. 问题背景

### 1.1 项目目标

实现完整的 S2S 翻译流程：
- **中文语音** → Whisper ASR → **中文文本**
- **中文文本** → Marian NMT → **英文文本**
- **英文文本** → Piper TTS → **英文语音**

### 1.2 技术栈

- **ASR**: Whisper (whisper-rs)
- **NMT**: Marian ONNX (ort 1.16.3)
- **TTS**: Piper HTTP (WSL2 服务)

### 1.3 测试文件

- `core/engine/examples/test_s2s_full_simple.rs` - 完整 S2S 流程测试

---

## 2. 问题详情

### 2.1 问题 1: Windows 链接器错误 ✅ 已解决

#### 问题描述

编译测试程序时出现链接器错误：
```
error LNK2038: 检测到"RuntimeLibrary"的不匹配项: 
值"MD_DynamicRelease"不匹配值"MT_StaticRelease"
```

#### 根本原因

- `whisper-rs-sys` 使用动态 C++ 运行时库 (`/MD`)
- `esaxx-rs`（tokenizers 的间接依赖）使用静态 C++ 运行时库 (`/MT`)
- 两者无法链接在一起

#### 解决方案

1. 复制 `esaxx-rs` 源码到 `third_party/esaxx-rs`
2. 修改 `build.rs`，移除 `.static_crt(true)`，强制使用动态运行时库
3. 在 `Cargo.toml` 中使用 `[patch.crates-io]` 覆盖依赖

#### 状态

✅ **已解决** - 编译和链接成功

---

### 2.2 问题 2: ONNX IR 版本兼容性问题 🔴 待解决

#### 问题描述

运行 S2S 测试时，Marian NMT 模型无法加载：
```
Unsupported model IR version: 10, max supported IR version: 9
```

#### 根本原因

- **模型**: `marian-zh-en`（中文→英文）使用 IR 10, Opset 18
- **运行时**: `ort` 1.16.3 只支持 IR version ≤ 9
- **不兼容**: 无法加载 IR 10 模型

#### 技术细节

**ONNX IR 版本**:
- IR (Intermediate Representation) 版本是 ONNX 模型的格式版本
- 新版本 PyTorch 默认导出 IR 10 模型
- 旧版本 ONNX Runtime 只支持 IR 9

**模型版本分布**:
- ✅ `marian-en-zh`（英文→中文）: IR 9, Opset 18（兼容）
- ❌ `marian-zh-en`（中文→英文）: IR 10, Opset 18（不兼容）
- ❌ 其他所有模型: IR 10, Opset 18（不兼容）

#### 尝试的解决方案

**方案 A: 手动降级 IR 版本** ❌ 失败

- 使用 `scripts/convert_onnx_ir9.py` 将模型从 IR 10 降级到 IR 9
- **结果**: 失败
- **原因**: 手动降级只修改了元数据（IR version 和 opset version），但模型内部的操作定义仍然使用了 opset 18 的特性（如 `Shape` 操作的 `start` 属性），导致运行时错误：
  ```
  Error Unrecognized attribute: start for operator Shape
  ```

**方案 B: 恢复原始模型** ✅ 已完成

- 从备份恢复原始 IR 10 模型
- **状态**: 已完成，模型已恢复

---

## 3. 影响分析

### 3.1 功能影响

#### 当前阻塞的功能

- ❌ **完整 S2S 测试（中文→英文）**: 无法运行
  - 需要 `marian-zh-en` 模型（IR 10）
  - 当前 `ort` 1.16.3 不支持

#### 不受影响的功能

- ✅ **NMT 功能（英文→中文）**: 正常工作
  - 使用 `marian-en-zh` 模型（IR 9）
  - 所有现有测试和功能正常

- ✅ **ASR 功能**: 正常工作
  - 使用 Whisper（不依赖 ONNX Runtime）

- ✅ **TTS 功能**: 正常工作
  - 英文 TTS: FastSpeech2（IR 9，兼容）
  - 中文 TTS: Piper HTTP（不依赖 ONNX Runtime）

- ⚠️ **Emotion 功能**: 当前无法加载
  - Emotion XLM-R 模型也是 IR 10
  - 但这不是本次测试的目标

### 3.2 依赖分析

**ort 依赖范围**:

1. **NMT (Marian ONNX)** - 核心功能
   - 所有翻译功能依赖 `ort`
   - 当前使用 `marian-en-zh`（IR 9）正常工作

2. **Emotion (XLM-R)** - 核心功能
   - 情感分析功能依赖 `ort`
   - 当前无法加载（IR 10 模型）

3. **TTS (FastSpeech2, VITS)** - 核心功能
   - 英文文本转语音依赖 `ort`
   - 当前使用 IR 9 模型正常工作

### 3.3 风险评估

**升级 ort 的风险**:

- ⚠️ **高风险**: 影响三个核心模块（NMT、Emotion、TTS）
- ⚠️ **需要全面测试**: 所有使用 `ort` 的功能都需要重新测试
- ⚠️ **API 兼容性**: 可能有 API 变化，需要修改代码
- ⚠️ **模型兼容性**: 可能影响现有 IR 9 模型的加载

---

## 4. 解决方案

### 4.1 方案 1: 使用 `marian-en-zh` 进行测试 ⭐ 推荐

#### 描述

修改测试使用 `marian-en-zh`（英文→中文），验证 S2S 流程（英文→中文）。

#### 优点

- ✅ **风险最低**: 无需修改任何依赖或模型
- ✅ **快速验证**: 可以立即验证 S2S 流程
- ✅ **不影响现有功能**: 所有现有功能继续正常工作
- ✅ **无需升级**: 不需要升级 `ort`

#### 缺点

- ⚠️ **测试方向不同**: 测试的是英文→中文流程，不是中文→英文流程
- ⚠️ **不符合原始目标**: 原始目标是测试中文→英文流程

#### 实施步骤

1. 修改 `test_s2s_full_simple.rs` 使用 `marian-en-zh`
2. 调整测试流程为：英文语音 → 英文文本 → 中文文本 → 中文语音
3. 运行测试验证 S2S 流程

#### 工作量

- **开发时间**: 1-2 小时
- **测试时间**: 1 小时
- **总时间**: 2-3 小时

---

### 4.2 方案 2: 升级 ONNX Runtime ⚠️ 高风险

#### 描述

升级 `ort` 到支持 IR 10 的版本，使 `marian-zh-en` 模型可以加载。

#### 优点

- ✅ **支持 IR 10**: 可以加载所有 IR 10 模型
- ✅ **符合原始目标**: 可以测试中文→英文流程
- ✅ **解决 Emotion 问题**: Emotion 模型也可以加载

#### 缺点

- ❌ **高风险**: 影响三个核心模块
- ❌ **需要全面测试**: 所有功能都需要重新测试
- ❌ **可能有 API 变化**: 需要修改代码
- ❌ **可能影响现有功能**: 可能影响现有 IR 9 模型

#### 实施步骤

1. 检查 `ort` 最新版本和支持的 IR 版本
2. 在测试分支升级 `ort`
3. 检查 API 变化，更新代码
4. 运行所有测试（NMT、Emotion、TTS）
5. 修复发现的问题
6. 全面测试所有功能
7. 如果通过，合并到主分支

#### 工作量

- **调研时间**: 2-4 小时
- **开发时间**: 4-8 小时（取决于 API 变化）
- **测试时间**: 4-8 小时（全面测试）
- **总时间**: 10-20 小时

#### 风险评估

- **技术风险**: 高
- **时间风险**: 高
- **功能风险**: 高

---

### 4.3 方案 3: 重新导出 IR 9 版本的 `marian-zh-en` 模型

#### 描述

使用旧版本 PyTorch（支持 opset 12）重新导出 `marian-zh-en` 模型为 IR 9。

#### 优点

- ✅ **无需升级**: 不需要升级 `ort`
- ✅ **符合原始目标**: 可以测试中文→英文流程
- ✅ **不影响现有功能**: 所有现有功能继续正常工作

#### 缺点

- ⚠️ **需要旧版本 PyTorch**: 需要安装和配置旧版本环境
- ⚠️ **可能无法使用最新特性**: 旧版本可能不支持某些模型特性
- ⚠️ **需要重新导出**: 需要重新导出模型

#### 实施步骤

1. 安装 PyTorch 1.x（支持 opset 12）
2. 使用旧版本重新导出 `marian-zh-en` 模型
3. 验证模型兼容性
4. 运行测试

#### 工作量

- **环境准备**: 2-4 小时
- **模型导出**: 2-4 小时
- **测试时间**: 2 小时
- **总时间**: 6-10 小时

#### 风险评估

- **技术风险**: 中
- **时间风险**: 中
- **功能风险**: 低

---

## 5. 推荐方案

### 5.1 短期方案（立即执行）⭐

**推荐使用方案 1（使用 `marian-en-zh` 进行测试）**

**理由**:
1. **风险最低**: 无需修改任何依赖或模型
2. **快速验证**: 可以立即验证 S2S 流程
3. **不影响现有功能**: 所有现有功能继续正常工作
4. **成本最低**: 工作量最小（2-3 小时）

**目标**:
- 验证 S2S 流程的完整性和正确性
- 确认所有组件（ASR、NMT、TTS）可以协同工作
- 虽然测试方向不同（英文→中文），但可以验证流程本身

### 5.2 长期方案（后续考虑）

**如果需要中文→英文流程，考虑方案 2 或方案 3**:

- **方案 2（升级 ort）**: 如果团队有足够时间进行全面测试
- **方案 3（重新导出模型）**: 如果希望避免升级 `ort` 的风险

---

## 6. 决策建议

### 6.1 立即行动

1. ✅ **采用方案 1**: 使用 `marian-en-zh` 进行测试
   - **时间**: 2-3 小时
   - **风险**: 低
   - **收益**: 验证 S2S 流程

### 6.2 后续规划

2. 🔄 **评估长期方案**: 
   - 如果需要中文→英文流程，评估方案 2 或方案 3
   - 考虑团队资源和时间安排

### 6.3 风险控制

3. ⚠️ **如果选择方案 2（升级 ort）**:
   - 在测试分支进行
   - 制定全面的测试计划
   - 准备回滚方案

---

## 7. 附录

### 7.1 相关文档

- `docs/architecture/MARIAN_NMT_IR_VERSION_ISSUE.md` - IR 版本问题详情
- `docs/architecture/MARIAN_NMT_MODEL_VERSION_HISTORY.md` - 模型版本历史
- `docs/architecture/ORT_UPGRADE_ANALYSIS.md` - ort 升级分析
- `docs/architecture/ORT_UPGRADE_RECOMMENDATION.md` - ort 升级建议
- `docs/architecture/LINKER_ISSUE_FIX_SUMMARY.md` - 链接器问题修复总结

### 7.2 相关文件

- `core/engine/examples/test_s2s_full_simple.rs` - S2S 测试文件
- `core/engine/Cargo.toml` - 依赖配置
- `core/engine/models/nmt/marian-zh-en/` - 模型目录
- `scripts/convert_onnx_ir9.py` - IR 版本转换脚本
- `scripts/restore_marian_zh_en_original.ps1` - 模型恢复脚本

### 7.3 技术细节

**ONNX IR 版本**:
- IR 9: 支持 opset ≤ 12
- IR 10: 支持 opset 13-18

**ort 版本支持**:
- ort 1.16.3: 支持 IR ≤ 9
- ort 最新版本: 需要调研

**模型状态**:
- `marian-en-zh`: IR 9, Opset 18 ✅
- `marian-zh-en`: IR 10, Opset 18 ❌
- Emotion XLM-R: IR 10, Opset 18 ❌

---

## 8. 总结

### 当前状态

- ✅ **链接器问题**: 已解决
- 🔴 **IR 版本问题**: 待解决
- ✅ **模型恢复**: 已完成

### 推荐行动

1. **立即**: 采用方案 1（使用 `marian-en-zh` 进行测试）
2. **后续**: 根据需求评估方案 2 或方案 3

### 关键决策点

- **是否需要立即测试中文→英文流程？**
  - 是 → 考虑方案 2 或方案 3
  - 否 → 采用方案 1

- **是否有足够时间进行全面测试？**
  - 是 → 可以考虑方案 2（升级 ort）
  - 否 → 采用方案 1 或方案 3

---

**报告结束**

如有任何问题，请联系开发团队。

