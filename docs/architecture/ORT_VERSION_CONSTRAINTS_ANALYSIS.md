# ONNX Runtime (ort) 版本限制分析

**日期**: 2025-11-21  
**问题**: 为什么项目无法使用 ort 2.0？

---

## 1. 历史背景

### 1.1 之前尝试过 ort 2.0

根据文档记录，项目之前曾经尝试过使用 `ort 2.0.0-rc.10`（候选版本）：

**文档来源**: `KV_CACHE_OPTIMIZATION_PLANS.md`
> "升级到 `ort = 2.0.0-rc.10`（之前使用过，但有其他问题）"

**文档来源**: `core/engine/docs/KV_CACHE_EXPLANATION.md`
> "当前使用的是 `ort 2.0.0-rc.10`（候选版本）"  
> "可能存在已知的内存安全问题"

### 1.2 当前版本

**当前使用**: `ort = "1.16.3"`（稳定版本）

**文档来源**: `core/engine/Cargo.toml`
```toml
ort = { version = "1.16.3", default-features = false, features = ["download-binaries"] }
```

---

## 2. 无法使用 ort 2.0 的原因

### 2.1 之前遇到的问题

根据文档记录，使用 `ort 2.0.0-rc.10` 时遇到了以下问题：

1. **内存安全问题**:
   - 文档提到"可能存在已知的内存安全问题"
   - 可能导致程序崩溃或未定义行为

2. **其他问题**:
   - 文档提到"之前使用过，但有其他问题"
   - 具体问题未详细记录，但足以导致回退到 1.16.3

### 2.2 升级风险

**文档来源**: `core/engine/docs/archived/EMOTION_FIX_IMPACT_ANALYSIS.md`

#### 影响范围

升级 ort 会影响所有使用 ONNX 的模块：
- ⚠️ **NMT 模块**（`nmt_incremental/`）
- ⚠️ **Emotion 模块**（`emotion_adapter/`）
- ⚠️ **TTS 模块**（`tts_streaming/` 中的 FastSpeech2, VITS）

#### API 变化风险

- `ort` 2.0.0 可能有 API 变化
- 需要修改 NMT 和 Emotion 的代码
- 需要全面测试所有功能

#### 风险评估

**文档来源**: `core/engine/docs/archived/EMOTION_FIX_IMPACT_ANALYSIS.md`

| 风险项 | 风险等级 | 说明 |
|--------|---------|------|
| 影响范围 | 🟡 中高 | 影响所有 ONNX 模块 |
| API 兼容性 | 🟡 中高 | 可能有 API 变化 |
| 功能稳定性 | 🟡 中高 | 需要全面测试 |
| 回滚难度 | 🟡 中 | 需要同时回滚代码和依赖 |

**不推荐升级的原因**:
- ⚠️ 需要修改 NMT 代码（可能破坏现有功能）
- ⚠️ 需要全面测试 NMT（工作量大）
- ⚠️ 风险较高，可能影响已完成的 NMT 功能

---

## 3. 当前约束

### 3.1 版本固定为 1.16.3

**文档来源**: `core/engine/docs/archived/EMOTION_ORT_FIXED_ISSUE_ANALYSIS.md`

> "在 `ort` 版本固定为 1.16.3（不支持 IR 10）的情况下，我们遇到以下问题"

**原因**:
1. **稳定性**: 1.16.3 是稳定版本，经过验证
2. **兼容性**: 现有代码基于 1.16.3 编写
3. **风险控制**: 避免引入之前遇到的问题

### 3.2 IR 版本限制

**ort 1.16.3 的限制**:
- 只支持 ONNX IR version ≤ 9
- 不支持 IR 10 模型

**影响**:
- ❌ 无法加载 IR 10 模型（如 `marian-zh-en`）
- ❌ Emotion XLM-R 模型无法加载（IR 10）

---

## 4. 为什么不能升级到 ort 2.0？

### 4.1 技术原因

1. **之前的问题未解决**:
   - 内存安全问题
   - 其他未知问题

2. **API 兼容性**:
   - ort 2.0 可能有 API 变化
   - 需要修改大量代码

3. **稳定性风险**:
   - 2.0.0-rc.10 是候选版本，不是稳定版
   - 可能引入新的 bug

### 4.2 业务原因

1. **影响范围大**:
   - 影响所有 ONNX 模块（NMT、Emotion、TTS）
   - 需要全面测试

2. **开发成本高**:
   - 需要修改代码
   - 需要全面测试
   - 需要处理可能的 bug

3. **风险控制**:
   - 现有功能已经稳定
   - 升级可能破坏现有功能

### 4.3 项目状态

**当前状态**:
- ✅ NMT 功能正常工作（使用 `marian-en-zh`，IR 9）
- ✅ TTS 功能正常工作（英文 TTS，IR 9）
- ⚠️ Emotion 功能无法加载（IR 10 模型）
- ⚠️ 部分 NMT 模型无法加载（IR 10 模型）

**升级的必要性**:
- 如果需要使用 IR 10 模型，可能需要升级
- 但需要权衡风险和收益

---

## 5. 替代方案

### 5.1 使用 IR 9 模型

**方案**: 使用兼容 IR 9 的模型

**优点**:
- ✅ 无需升级 ort
- ✅ 不影响现有功能
- ✅ 风险最低

**缺点**:
- ⚠️ 可能需要重新导出模型
- ⚠️ 可能无法使用最新模型特性

### 5.2 使用旧版本 PyTorch 重新导出

**方案**: 使用支持 opset 12 的旧版本 PyTorch 重新导出模型

**优点**:
- ✅ 可以导出真正的 IR 9 模型
- ✅ 兼容 ort 1.16.3
- ✅ 不需要升级 ort

**缺点**:
- ⚠️ 需要安装旧版本 PyTorch
- ⚠️ 可能无法使用最新模型特性

### 5.3 等待 ort 2.0 稳定版

**方案**: 等待 ort 2.0 正式发布稳定版

**优点**:
- ✅ 稳定版本，问题更少
- ✅ 可能修复之前的问题

**缺点**:
- ⚠️ 时间不确定
- ⚠️ 可能仍有兼容性问题

---

## 6. 总结

### 6.1 为什么不能使用 ort 2.0？

1. **历史问题**: 之前使用 `ort 2.0.0-rc.10` 时遇到内存安全问题和其他问题
2. **稳定性**: 2.0.0-rc.10 是候选版本，不是稳定版
3. **影响范围**: 升级会影响所有 ONNX 模块，需要全面测试
4. **开发成本**: 需要修改代码、全面测试、处理可能的 bug
5. **风险控制**: 现有功能已经稳定，升级可能破坏现有功能

### 6.2 当前策略

**固定使用 ort 1.16.3**:
- ✅ 稳定版本，经过验证
- ✅ 现有代码基于此版本
- ✅ 风险最低

**处理 IR 10 模型**:
- 使用 IR 9 兼容的模型
- 或使用旧版本 PyTorch 重新导出模型
- 或等待 ort 2.0 稳定版

### 6.3 未来考虑

**如果必须升级 ort 2.0**:
1. 等待稳定版发布
2. 在测试分支进行充分测试
3. 评估 API 变化和兼容性
4. 制定全面的测试计划
5. 准备回滚方案

---

## 7. 相关文档

- `KV_CACHE_OPTIMIZATION_PLANS.md` - 提到之前使用过 ort 2.0.0-rc.10
- `core/engine/docs/KV_CACHE_EXPLANATION.md` - 提到内存安全问题
- `core/engine/docs/archived/EMOTION_FIX_IMPACT_ANALYSIS.md` - 升级风险评估
- `core/engine/docs/archived/EMOTION_ORT_FIXED_ISSUE_ANALYSIS.md` - ort 版本固定说明
- `core/engine/Cargo.toml` - 当前版本配置

---

**最后更新**: 2025-11-21  
**状态**: ort 版本固定为 1.16.3，不推荐升级到 2.0

