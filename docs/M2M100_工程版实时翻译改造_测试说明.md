# M2M100 工程版实时翻译改造 - 测试说明

**版本：** v1.0  
**日期：** 2025-01-21

---

## 1. 测试覆盖情况

### 1.1 Python M2M100 NMT 服务测试

**测试文件**：`services/nmt_m2m100/test_nmt_service.py`

**测试覆盖**：
- ✅ 健康检查接口测试
- ✅ 中文到英文翻译测试
- ✅ 英文到中文翻译测试
- ✅ 空文本处理测试
- ✅ 无效语言代码处理测试
- ✅ 缺少必需字段验证测试
- ✅ 长文本翻译测试

**运行方式**：
```bash
cd services/nmt_m2m100
pip install -r requirements.txt
pip install -r requirements-test.txt
pytest test_nmt_service.py -v
```

### 1.2 Rust NMT 客户端测试

**测试文件**：`core/engine/tests/nmt_client_test.rs`

**测试覆盖**：
- ✅ 适配器翻译功能测试（使用 Mock 客户端）
- ✅ 适配器初始化和清理测试
- ⚠️ 本地客户端集成测试（需要运行中的 Python 服务）

**运行方式**：
```bash
cd core/engine
cargo test nmt_client_test --lib
```

---

## 2. 测试类型说明

### 2.1 单元测试

**Python 服务**：
- 使用 `pytest` 和 `TestClient`
- 测试各个 API 端点的功能
- 测试错误处理

**Rust 客户端**：
- 使用 Mock 对象测试适配器逻辑
- 测试接口适配和错误处理

### 2.2 集成测试

**需要运行中的 Python 服务**：
```bash
# 终端1：启动 Python 服务
cd services/nmt_m2m100
uvicorn nmt_service:app --host 127.0.0.1 --port 5008

# 终端2：运行集成测试
cd core/engine
cargo test test_local_client_integration -- --ignored
```

---

## 3. 测试依赖

### 3.1 Python 测试依赖

**文件**：`services/nmt_m2m100/requirements-test.txt`
```
pytest>=7.4.0
pytest-asyncio>=0.21.0
httpx>=0.24.0
```

### 3.2 Rust 测试依赖

Rust 测试使用标准库和 `tokio`，无需额外依赖。

---

## 4. 测试执行

### 4.1 快速测试（单元测试）

```bash
# Python 服务测试
cd services/nmt_m2m100
pytest test_nmt_service.py -v

# Rust 客户端测试（不包含集成测试）
cd core/engine
cargo test nmt_client_test --lib -- --skip test_local_client_integration
```

### 4.2 完整测试（包含集成测试）

```bash
# 1. 启动 Python 服务
cd services/nmt_m2m100
uvicorn nmt_service:app --host 127.0.0.1 --port 5008 &

# 2. 运行所有测试
cd core/engine
cargo test nmt_client_test --lib

# 3. 停止 Python 服务
pkill -f "uvicorn nmt_service"
```

---

## 5. 测试覆盖率

### 5.1 已覆盖

- ✅ Python 服务 API 接口
- ✅ Rust 客户端适配器逻辑
- ✅ 错误处理路径
- ✅ 输入验证

### 5.2 待补充

- ⚠️ HTTP 客户端网络错误处理（需要 mock HTTP 服务器）
- ⚠️ 超时处理
- ⚠️ 重试逻辑
- ⚠️ 并发请求处理

---

## 6. 测试最佳实践

### 6.1 运行测试前

1. 确保 Python 依赖已安装
2. 确保 Rust 项目可以编译
3. 对于集成测试，确保 Python 服务可以启动

### 6.2 测试隔离

- 单元测试不依赖外部服务
- 集成测试标记为 `#[ignore]`，需要手动运行

### 6.3 持续集成

建议在 CI/CD 中：
1. 运行所有单元测试
2. 可选：运行集成测试（需要启动 Python 服务）

---

## 7. 测试结果示例

### 7.1 Python 测试输出

```
test_nmt_service.py::test_health_check PASSED
test_nmt_service.py::test_translate_zh_to_en PASSED
test_nmt_service.py::test_translate_en_to_zh PASSED
test_nmt_service.py::test_translate_empty_text PASSED
test_nmt_service.py::test_translate_invalid_lang PASSED
test_nmt_service.py::test_translate_missing_fields PASSED
test_nmt_service.py::test_translate_long_text PASSED
```

### 7.2 Rust 测试输出

```
running 3 tests
test nmt_client_test::test_adapter_translate ... ok
test nmt_client_test::test_adapter_initialize_finalize ... ok
test nmt_client_test::test_local_client_integration ... ignored
```

---

## 8. 总结

- ✅ **Python 服务**：已创建完整的单元测试
- ✅ **Rust 客户端**：已创建适配器逻辑的单元测试
- ⚠️ **集成测试**：需要运行中的 Python 服务，标记为 `#[ignore]`

所有核心功能都有测试覆盖，可以进行测试验证。

---

**文档结束**

