# ASR 和 NMT 测试总结

**日期**: 2025-11-21  
**状态**: 🔍 **问题诊断中**

---

## ✅ 已完成的工作

1. **创建单元测试**
   - ✅ ASR 单元测试 (`tests/asr_whisper_test.rs`)
   - ✅ NMT 单元测试 (`tests/nmt_m2m100_test.rs`)

2. **添加调试功能**
   - ✅ 在 NMT 解码循环中添加重复 token 检测
   - ✅ 添加详细的日志输出

---

## 🔍 问题 1: ASR 识别问题

### 测试结果

**中文音频测试** (`chinese.wav`):
- **识别结果**: "Hello welcome to the video of the video."
- **检测到的语言**: "unknown"
- **文本推断**: 英文（文本主要为英文字符）
- **问题**: ❌ 中文音频被识别为英文

**英文音频测试** (`english.wav`):
- ⏳ 测试失败（需要进一步调试）

### 分析

从 Whisper 日志看：
- `prompt[1] = [_LANG_en]` - Whisper 检测到英文
- 识别结果为英文文本
- 但 `final_transcript.language` 返回 "unknown"

### 可能原因

1. **音频文件问题**
   - 虽然用户已验证音频文件，但 Whisper 可能无法正确识别
   - 需要检查音频格式（采样率、声道数、位深等）

2. **Whisper 模型问题**
   - Whisper Base 模型可能对中文支持不够好
   - 可能需要使用更大的模型或专门的中文模型

3. **语言检测问题**
   - Whisper 的语言检测可能不准确
   - 需要验证音频文件的实际内容

### 下一步

1. ⏳ 检查音频文件的实际内容
2. ⏳ 验证 Whisper 的语言检测功能
3. ⏳ 测试英文音频识别

---

## 🔍 问题 2: NMT 翻译重复 Token 问题

### 测试结果

**中文→英文翻译**:
- **输入**: "你好，世界"
- **生成的 token 序列**: `[2, 128022, 7486, 81703, 125179, 2940, 66838, 1326]`
- **解码结果**: `'鈻亂m 鈻丼chutz 瀚?鈻並om 喔熰副喔?鈻乵eng'`
- **问题**: ⚠️ 解码结果包含乱码

**英文→中文翻译**:
- **输入**: "Hello, world"
- **生成的 token 序列**: `[2, 128102, 22, 3, 22, 3, 22, 3, ...]`
- **解码结果**: `'鈻?<unk> 鈻?<unk> 鈻?<unk> ...'`
- **问题**: ❌ 严重的重复 token 问题

### 分析

从日志看，解码过程如下：

**Step 0**:
- 输入: `[2]` (decoder_start_token_id)
- 强制选择: `128102` (目标语言 token)

**Step 1**:
- 输入: `[128102]`
- 选择: `22` (最高 logits)

**Step 2**:
- 输入: `[22]`
- 选择: `3` (最高 logits)

**Step 3**:
- 输入: `[3]`
- 选择: `22` (最高 logits) ← **重复！**

**Step 4**:
- 输入: `[22]`
- 选择: `3` (最高 logits) ← **重复！**

### 可能原因

1. **KV Cache 更新问题**
   - KV cache 可能没有正确更新
   - 每次步骤的 KV cache 可能被错误地重置或覆盖

2. **解码逻辑问题**
   - 增量解码模式可能有问题
   - `use_cache_branch` 标志可能设置不正确

3. **模型输入格式问题**
   - 输入 token 序列的格式可能不正确
   - 可能需要包含完整的历史序列，而不仅仅是最后一个 token

4. **EOS Token 检测问题**
   - EOS token 可能没有被正确检测
   - 导致解码循环无法正常终止

### 已实施的临时措施

✅ 添加重复 token 检测：
- 如果检测到重复模式，提前停止解码
- 这只是临时措施，需要找到根本原因

### 下一步

1. ⏳ 添加详细的调试日志，跟踪 KV cache 的更新过程
2. ⏳ 检查 decoder_step 的实现，验证 KV cache 更新逻辑
3. ⏳ 对比 Python 参考实现，验证解码逻辑
4. ⏳ 检查模型输入格式是否正确

---

## 📊 测试统计

### ASR 单元测试
- ✅ 1 个测试通过
- ❌ 1 个测试失败
- ⏳ 需要进一步调试

### NMT 单元测试
- ✅ 2 个测试通过（但结果有问题）
- ❌ 发现重复 token 问题
- ❌ 解码结果包含 `<unk>` 和乱码

---

## 🛠️ 下一步行动

### 优先级 1: 修复 NMT 重复 Token 问题

1. **添加详细的调试日志**
   - 在 `decoder_step` 中添加 KV cache 形状和内容的日志
   - 在 `translate` 中添加每个步骤的输入和输出日志

2. **检查 KV Cache 更新逻辑**
   - 验证 KV cache 是否正确传递到下一步
   - 检查 KV cache 的形状是否正确

3. **验证解码逻辑**
   - 对比 Python 参考实现
   - 检查增量解码模式的实现

### 优先级 2: 修复 ASR 识别问题

1. **运行完整的 ASR 测试**
   - 验证中文和英文音频的识别结果
   - 检查音频文件的实际内容

2. **检查 Whisper 配置**
   - 验证语言检测参数
   - 检查是否需要指定语言提示

3. **验证音频格式**
   - 检查采样率、声道数、位深等
   - 确保音频格式符合 Whisper 的期望

---

## 📚 参考

- ASR Whisper 实现: `core/engine/src/asr_whisper/`
- NMT M2M100 实现: `core/engine/src/nmt_incremental/m2m100_*.rs`
- 单元测试: `core/engine/tests/asr_whisper_test.rs`, `core/engine/tests/nmt_m2m100_test.rs`
- 诊断报告: `docs/models/ASR_NMT_ISSUE_DIAGNOSIS.md`

