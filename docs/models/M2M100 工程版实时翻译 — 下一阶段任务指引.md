M2M100 工程版实时翻译 — 下一阶段任务指引

版本：2025-11-22
面向对象：开发部门
目的：明确当前状态、下一步任务、验收标准

1. 当前状态总结

根据本阶段的实现与测试情况，当前系统已具备以下状态：

✔ 已完成

已从 增量解码 + KV cache 改为 句级非增量解码（工程版模式）

模型接口保持不变（bootstrap / trait 未被修改）

decoder 能正常运行并输出 token 序列

encoder + decoder 已可整合运行，流程完整可执行

全零 KV 输入已按模型 signature 正确传入

⚠ 当前存在的问题（属于预期范围）

翻译结果出现 2-token 循环模式

detokenize 输出可能出现 乱码字符

部分句子无法正确进入 EOS

HF 与 ONNX 输出不一致（差异 significant）

这些问题在“从增量 → 非增量”的迁移过渡阶段属 正常现象，需要进一步对齐。

2. 下一阶段必须执行的任务（按优先级）
任务 1：HF vs ONNX 的“非增量逐步对齐”测试（最关键）

目标：确认 ONNX decoder 行为是否和 HF 深度一致。

执行方式：

使用同一句输入，例如
「你好，欢迎参加测试。」

在 Python 中强制 非增量解码：

每次把 完整目标序列 传入 HF（不使用 past）

记录每步 logits top-5、next token

在 ONNX 中执行同样的非增量步骤：

input_ids = 当前完整生成序列

encoder_hidden_states / attention_mask 不变

KV 全零，但形状必须匹配模型要求

比对 32 步内每步的前五个 logits

判定指标：

如果 HF 与 ONNX 前 3 步 logits 即开始偏离
→ 表示 ONNX decoder 输入/分支选择仍然不正确

如果前 3~5 步一致，而后面开始偏离
→ 表示循环、EOS、decoder_start_token 或 KV 分支逻辑未对齐

这是当前最重要的任务，没有完成该对齐，后续所有调优都无意义。

任务 2：验证 detokenize（token → 文本）是否正确

问题：目前出现 '鈻?瀹?' 等乱码，需要确认是：

模型输出错误 token
还是

Rust 的 detokenize 实现错误

执行方式：

记录 Rust 的 generated_ids

复制到 Python：

from transformers import M2M100Tokenizer
tok = M2M100Tokenizer.from_pretrained("facebook/m2m100_418M")
print(tok.decode(ids, skip_special_tokens=False))

判定：

Python 也乱码 → 模型输出不合理的 token

Python 正常 → Rust detokenize 有 bug（例如 UTF-8 编码丢失）

任务 3：确认 decoder_start_token + EOS 逻辑完全正确

常见导致循环的源头：

BOS（target lang token）是否只注入一次？

EOS token 是否传错？（M2M100 EOS = 2）

是否在条件分支中被覆盖？

验证重点：
generated_ids = vec![lang_id];   // 仅一次
if next_token == eos_id { break; }

任务 4：检查 use_cache_branch / use_cache 传参是否正确

M2M100 导出的 ONNX decoder 通常包含：

branch A: 使用 KV (use_cache_branch=True)
branch B: 不使用 KV (use_cache_branch=False)


必须确保你们走的是：

branch B（不依赖 past/present 逻辑）

否则 decoder 会试图使用全零 KV 来做增量逻辑 → logits 大乱。

任务 5：运行短句压力测试（验证 EOS + 重复 Token）

准备 10 条测试句：

简短中文：你好 / 好的 / 今天怎么样

带标点：你好！

英文：hello world

混合：你好 hello

记录：

token 序列

是否能进入 EOS

重复 token 是否减少

3. 验收标准（达到这些即可进入下一阶段）
✔ HF / ONNX 前 3 步 logits 高度一致（最重要）
✔ detokenize 不再出现乱码
✔ token 不再出现 2-token 循环模式
✔ 普通句子可成功触发 EOS
✔ 延迟 < 800ms（句长 10–20 token）

满足以上条件即可称为“工程版 M2M100 句级实时翻译正确上线”。