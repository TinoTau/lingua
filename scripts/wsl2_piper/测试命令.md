# TTS GPU 测试命令

## 快速测试

### 1. 测试 ONNX Runtime GPU 支持

```bash
cd ~/piper_env
source .venv/bin/activate
export LD_LIBRARY_PATH=/usr/local/cuda-12.4/targets/x86_64-linux/lib:/usr/local/cuda-12.4/lib64:/lib/x86_64-linux-gnu:$LD_LIBRARY_PATH
python -c "import onnxruntime as ort; providers = ort.get_available_providers(); print('可用执行提供程序:', providers); print('CUDA 可用:', 'CUDAExecutionProvider' in providers)"
```

**预期输出**：
```
可用执行提供程序: ['TensorrtExecutionProvider', 'CUDAExecutionProvider', 'CPUExecutionProvider']
CUDA 可用: True
```

### 2. 测试 Piper TTS GPU（基础测试）

```bash
cd ~/piper_env
source .venv/bin/activate
export LD_LIBRARY_PATH=/usr/local/cuda-12.4/targets/x86_64-linux/lib:/usr/local/cuda-12.4/lib64:/lib/x86_64-linux-gnu:$LD_LIBRARY_PATH
python /mnt/d/Programs/github/lingua/scripts/wsl2_piper/test_piper_gpu.py
```

**预期输出**：
```
实际使用的执行提供程序: ['CUDAExecutionProvider', 'CPUExecutionProvider']
✓ 确认使用 GPU 加速
✓ 合成成功
```

### 3. 完整测试套件（推荐）

```bash
cd ~/piper_env
source .venv/bin/activate
export LD_LIBRARY_PATH=/usr/local/cuda-12.4/targets/x86_64-linux/lib:/usr/local/cuda-12.4/lib64:/lib/x86_64-linux-gnu:$LD_LIBRARY_PATH
python /mnt/d/Programs/github/lingua/scripts/wsl2_piper/test_tts_gpu_complete.py
```

**包含测试**：
- ONNX Runtime GPU 支持
- 模型文件存在性
- GPU 模式模型加载
- GPU 模式语音合成
- CPU vs GPU 性能对比

### 4. 测试 HTTP 服务（需要先启动服务）

**步骤 1：启动 TTS 服务**

```bash
cd ~/piper_env
source .venv/bin/activate
export LD_LIBRARY_PATH=/usr/local/cuda-12.4/targets/x86_64-linux/lib:/usr/local/cuda-12.4/lib64:/lib/x86_64-linux-gnu:$LD_LIBRARY_PATH
export PIPER_USE_GPU=true
python /mnt/d/Programs/github/lingua/scripts/wsl2_piper/piper_http_server.py --host 0.0.0.0 --port 5005
```

**步骤 2：在另一个终端测试服务（Windows PowerShell）**

```powershell
cd D:\Programs\github\lingua\scripts\wsl2_piper
.\test_piper_service.ps1
```

或者使用 curl（在 WSL2 中）：

```bash
curl -X POST http://127.0.0.1:5005/tts \
  -H "Content-Type: application/json" \
  -d '{"text":"测试GPU加速","voice":"zh_CN-huayan-medium"}' \
  --output test_output.wav
```

### 5. 验证 GPU 使用情况

**Windows PowerShell**（推荐）：
```powershell
# 实时监控（每秒刷新）
nvidia-smi -l 1

# 或者每 0.5 秒刷新（更流畅）
nvidia-smi -l 0.5
```

**WSL2 (Linux)**：
```bash
# 实时监控
watch -n 1 nvidia-smi

# 或者使用 nvidia-smi 自带的循环模式
nvidia-smi -l 1
```

**查看进程信息**：
```powershell
# Windows
nvidia-smi pmon -c 1

# WSL2
nvidia-smi pmon -c 1
```

如果 GPU 使用率上升，说明正在使用 GPU。

**详细说明**：请参考 `scripts/监控GPU使用情况.md`

## 一键测试脚本

也可以使用启动脚本自动设置环境并测试：

```bash
cd /mnt/d/Programs/github/lingua/scripts/wsl2_piper
bash start_piper_service.sh
```

然后在 Windows 中运行：

```powershell
cd D:\Programs\github\lingua\scripts\wsl2_piper
.\test_piper_service.ps1
```

