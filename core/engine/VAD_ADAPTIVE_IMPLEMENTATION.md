# VAD 自适应调整实现说明

## 实现概述

已实现**按用户的自适应VAD调整**功能，根据每个用户的实际语速自动调整VAD阈值，并将语速信息传递给TTS进行语音生成。

## 核心功能

### 1. 按用户语速跟踪

- **语速计算**：根据识别的文本长度和音频时长计算语速（字符/秒）
- **状态维护**：为每个说话者维护独立的语速历史和调整后的阈值
- **自适应调整**：
  - 快语速（> 8 字符/秒）→ 阈值缩短到 70%（更短的静音时长）
  - 慢语速（< 4 字符/秒）→ 阈值延长到 130%（更长的静音时长）
  - 正常语速（4-8 字符/秒）→ 保持原值

### 2. 动态阈值调整

- **平滑更新**：使用 `adaptive_rate`（默认 0.1）进行平滑调整，避免突变
- **边界限制**：阈值限制在 `min_duration_ms`（300ms）和 `max_duration_ms`（1200ms）之间
- **样本要求**：每个用户至少需要 `min_samples`（默认 3）个样本才开始调整

### 3. 语速传递给TTS

- **TTS接口扩展**：`TtsRequest` 新增 `speech_rate` 字段
- **自动传递**：在TTS合成时，自动获取说话者的平均语速并传递给TTS服务
- **TTS适配**：TTS服务可以根据语速调整合成速度，匹配原说话者的语速

## 配置说明

### 配置文件（`lingua_core_config.toml`）

```toml
[vad]
type = "silero"
silence_threshold = 0.5
min_silence_duration_ms = 600

# VAD 自适应调整配置（按用户）
[vad.adaptive]
# 是否启用自适应调整（根据每个用户的实际语速自动调整阈值）
enabled = true
# 每个用户至少需要这么多样本才开始调整（建议3-5个）
min_samples = 3
# 每次调整的幅度（0.0-1.0，建议0.1-0.2）
rate = 0.1
# 最小阈值限制（毫秒，防止调整过小）
min_duration_ms = 300
# 最大阈值限制（毫秒，防止调整过大）
max_duration_ms = 1200
```

## 工作流程

### 1. 说话者识别阶段

```
音频输入 → VAD检测边界 → 说话者识别 → 设置当前说话者ID
```

### 2. ASR识别阶段

```
ASR识别 → 获取文本和音频时长 → 计算语速 → 更新VAD中的说话者语速
```

### 3. VAD检测阶段

```
VAD检测 → 获取当前说话者ID → 使用自适应阈值 → 检测边界
```

### 4. TTS合成阶段

```
获取说话者语速 → 传递给TTS → TTS根据语速调整合成速度
```

## 代码结构

### SileroVad 新增功能

1. **SpeakerAdaptiveState**：每个说话者的自适应状态
   - `speech_rate_history`：语速历史（最近20个样本）
   - `adjusted_duration_ms`：调整后的阈值
   - `sample_count`：样本数量

2. **自适应方法**：
   - `update_speaker_speech_rate`：更新说话者语速
   - `get_adjusted_duration_ms`：获取调整后的阈值
   - `get_speaker_speech_rate`：获取说话者语速（用于TTS）
   - `set_current_speaker`：设置当前说话者ID

### CoreEngine 集成

1. **语速更新**：
   - 在ASR识别完成后，计算语速并更新到VAD
   - 支持非连续模式和连续模式

2. **语速传递**：
   - 在TTS合成时，获取说话者语速并传递给TTS
   - 支持一次性合成和增量合成

## 使用示例

### 场景：多人交谈

```
用户A（快语速，10 字符/秒）：
  - 初始阈值：600ms
  - 调整后阈值：420ms（600 * 0.7）
  - TTS语速：10 字符/秒

用户B（慢语速，3 字符/秒）：
  - 初始阈值：600ms
  - 调整后阈值：780ms（600 * 1.3）
  - TTS语速：3 字符/秒

用户C（正常语速，6 字符/秒）：
  - 初始阈值：600ms
  - 调整后阈值：600ms（保持不变）
  - TTS语速：6 字符/秒
```

## 调试日志

系统会输出以下调试信息：

```
[SileroVad] 📊 Speaker 'user_1': speech_rate=8.5 chars/s, adjusted_duration=420ms (samples=5)
[TTS] Using speaker speech rate: 8.5 chars/s for speaker: user_1
```

## 注意事项

1. **初始化阶段**：新用户需要至少 3 个样本才开始调整，在此之前使用基础阈值
2. **语速计算**：目前使用字符数/秒，对于英文可能需要调整为词数/秒
3. **TTS支持**：需要TTS服务支持语速参数，目前Piper和YourTTS需要检查是否支持

## 下一步

1. ✅ 实现按用户的自适应VAD
2. ✅ 扩展TTS接口支持语速
3. ⏳ 检查并更新Piper和YourTTS服务支持语速参数
4. ⏳ 测试自适应调整效果
5. ⏳ 优化语速计算（考虑不同语言的特点）

