# Silero VAD 修复说明

## 问题总结

根据问题报告 `SILERO_VAD_ISSUE_REPORT.md`，当前问题是：
1. 模型输出是 `[1, 1]` 形状，值为 `0.0006-0.0013`（非常小）
2. 应用 sigmoid 后所有值都变成约 `0.500`（因为 `sigmoid(0.0007) ≈ 0.5002`）
3. 所有音频帧都被识别为语音，无法区分静音和语音

## 修复方案

### 1. 输出值解析修复

**问题**：当输出值非常小（< 0.01）时，直接应用 sigmoid 会导致所有值都接近 0.5。

**修复**：将输出值乘以系数 1000 后再应用 sigmoid：
- 原始输出：`0.0007`
- 乘以 1000：`0.7`
- Sigmoid 后：`sigmoid(0.7) ≈ 0.668`

这样可以区分不同的输出值：
- 静音帧：输出值可能更小（比如 0.0006），乘以 1000 = 0.6，sigmoid(0.6) ≈ 0.646
- 语音帧：输出值可能更大（比如 0.0013），乘以 1000 = 1.3，sigmoid(1.3) ≈ 0.786

### 2. 代码修改位置

文件：`core/engine/src/vad/silero_vad.rs`

修改位置：`detect_voice_activity` 函数中的输出解析逻辑（约第 403-425 行）

**修改前**：
```rust
} else if raw_output < 0.01 && raw_output > -0.01 {
    // 值非常小，可能是 logit（接近 0），使用 sigmoid
    let prob = 1.0 / (1.0 + (-raw_output).exp());
    // ...
}
```

**修改后**：
```rust
} else if raw_output < 0.01 && raw_output > -0.01 {
    // 值非常小（0.0006-0.0013），可能是缩放的 logit
    // 乘以 1000 后再应用 sigmoid
    let scaled_logit = raw_output * 1000.0;
    let prob = 1.0 / (1.0 + (-scaled_logit).exp());
    // ...
}
```

### 3. 调试日志增强

添加了更详细的调试日志，输出其他可能的解析方式：
- `scale_100`：乘以 100 后的结果
- `direct`：直接使用原始值
- `inverted`：取反后的值

这有助于诊断问题，如果当前修复不工作，可以尝试其他解析方式。

## 测试建议

### 1. 运行测试

修复后，需要测试以下场景：
1. **静音音频**：应该被识别为静音（speech_prob < 0.2）
2. **语音音频**：应该被识别为语音（speech_prob > 0.2）
3. **混合音频**：应该能正确区分语音和静音段

### 2. 检查日志

运行后检查日志输出：
- 查看 `[SileroVad] 🔬` 开头的调试日志
- 确认输出值的解析是否正确
- 如果所有帧的 speech_prob 仍然接近，可能需要调整系数

### 3. 如果修复不工作

如果修复后问题仍然存在，可能需要：

1. **调整系数**：
   - 当前使用 1000，可以尝试 500、2000 或其他值
   - 根据实际输出值范围调整

2. **检查模型文件**：
   - 确认模型文件是否正确
   - 尝试从官方仓库重新下载模型

3. **检查输入格式**：
   - 确认音频输入格式是否正确（16kHz，单声道，[-1, 1] 范围）
   - 确认状态初始化是否正确

4. **参考官方实现**：
   - 查看官方 Python 实现如何处理输出
   - 对比输入输出格式

## 下一步行动

1. ✅ **修复代码**：已完成输出解析修复
2. ⏳ **测试修复**：需要运行测试验证修复是否有效
3. ⏳ **调整参数**：根据测试结果调整系数或阈值
4. ⏳ **文档更新**：如果修复成功，更新相关文档

## 相关文件

- 问题报告：`core/engine/SILERO_VAD_ISSUE_REPORT.md`
- 修复代码：`core/engine/src/vad/silero_vad.rs`
- 测试脚本：`core/engine/scripts/test_silero_vad_python_vs_rust.py`
- 下载脚本：`core/engine/scripts/download_and_test_silero_vad.py`

## 参考资料

- Silero VAD 官方仓库：https://github.com/snakers4/silero-vad
- ONNX Runtime 文档：https://onnxruntime.ai/docs/

---

**修复日期**：2024年（当前日期）  
**修复状态**：待测试  
**修复版本**：v1.0（系数 1000）

