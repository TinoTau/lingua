# TTS 模型问题分析

## 当前状态

✅ **测试通过**：TTS 合成流程可以运行，没有崩溃
⚠️ **音频质量**：生成的音频可能不正确（320 字节，160 个样本）

## 问题分析

### 1. 模型输入/输出不匹配

根据模型规范检查结果：

| 模型 | 输入形状 | 输出形状 | 问题 |
|------|---------|---------|------|
| FastSpeech2 | `[1, '?', 384]` (float32) | `[1, '?', 80]` (float32) | ✅ 正常 |
| HiFiGAN | `[1, '?', 384]` (float32) | `[1, '?', 80]` (float32) | ❌ 异常 |

**问题**：
- FastSpeech2 输出是 `[1, time_steps, 80]`（mel-spectrogram，80 维）
- HiFiGAN 期望输入是 `[1, time_steps, 384]`（384 维，不匹配！）
- HiFiGAN 输出是 `[1, time_steps, 80]`（不是音频波形！）

### 2. 当前临时解决方案

**FastSpeech2 → HiFiGAN 输入转换**：
- 将 80 维 mel-spectrogram 循环复制扩展到 384 维
- 这不是正确的做法，只是为了让模型能够运行

**HiFiGAN 输出处理**：
- HiFiGAN 输出是 `[1, 2, 80]`（3 维）
- 当前将其展平为 160 个样本（2 * 80 = 160）
- 这不是标准的音频波形格式

## 可能的原因

### 1. 模型不匹配
- FastSpeech2 和 HiFiGAN 可能不是配对的模型
- 它们可能来自不同的训练或导出流程

### 2. 模型导出问题
- 模型可能没有正确导出
- 可能缺少某些预处理/后处理步骤

### 3. 模型格式问题
- 这些可能不是标准的 FastSpeech2 + HiFiGAN 组合
- 可能是其他 TTS 架构的模型

## 解决方案

### 方案 1：检查模型文档（推荐）
1. 查找模型来源和文档
2. 确认模型的正确输入/输出格式
3. 确认是否需要额外的预处理/后处理

### 方案 2：使用不同的模型
1. 寻找标准的 FastSpeech2 + HiFiGAN 模型对
2. 确保模型输入/输出匹配：
   - FastSpeech2 输出：`[1, mel_dim, time_steps]` 或 `[1, time_steps, mel_dim]`
   - HiFiGAN 输入：与 FastSpeech2 输出匹配
   - HiFiGAN 输出：`[samples]` 或 `[1, samples]`（音频波形）

### 方案 3：实现特征转换层
1. 如果模型确实需要 384 维输入，实现正确的特征扩展
2. 如果 HiFiGAN 输出是特征而不是音频，实现特征到音频的转换

### 方案 4：使用其他 TTS 方案
1. 考虑使用其他 TTS 模型（如 Tacotron2, VITS 等）
2. 或者使用现成的 TTS 库（如 Coqui TTS, ESPnet 等）

## 当前代码状态

### 已实现的功能
- ✅ FastSpeech2 模型加载和推理
- ✅ HiFiGAN 模型加载和推理
- ✅ 文本预处理（简化版）
- ✅ 输入/输出形状转换（临时方案）
- ✅ PCM 音频生成
- ✅ TTS 集成到 CoreEngine

### 待解决的问题
- ❌ FastSpeech2 输入 embedding（当前是简单复制）
- ❌ 80 维到 384 维的特征扩展（当前是循环复制）
- ❌ HiFiGAN 输出处理（当前是简单展平）
- ❌ 文本预处理（当前是简化版，需要完整的音素转换）

## 下一步建议

### 短期（让功能可用）
1. **查找模型文档**：确认模型的正确使用方式
2. **测试音频质量**：保存生成的音频文件，检查是否可听
3. **实现基本的特征转换**：如果模型确实需要，实现正确的转换逻辑

### 中期（优化质量）
1. **完善文本预处理**：实现完整的文本规范化、音素转换
2. **优化特征扩展**：如果确实需要，实现正确的 embedding/特征扩展
3. **添加音频后处理**：归一化、去噪等

### 长期（生产就绪）
1. **替换为标准模型**：使用经过验证的 FastSpeech2 + HiFiGAN 模型对
2. **性能优化**：批处理、缓存、流式输出
3. **多语言支持**：支持更多语言的 TTS

## 测试建议

1. **保存音频文件**：修改测试代码，将生成的音频保存为 WAV 文件
2. **播放测试**：用音频播放器播放，检查是否可听
3. **对比测试**：如果有参考实现，对比输出

## 相关文件

- `core/engine/src/tts_streaming/fastspeech2_tts.rs` - TTS 引擎实现
- `core/engine/src/tts_streaming/text_processor.rs` - 文本预处理
- `scripts/check_tts_model_io.py` - 模型 I/O 检查脚本
- `core/engine/tests/tts_integration_test.rs` - TTS 集成测试

