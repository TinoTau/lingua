# Breeze2-VITS 模型问题总结

**日期**: 2024-12-19  
**状态**: 阻塞 - 生成的音频无法对应文本  
**优先级**: 高

---

## 执行摘要

我们测试了 `MediaTek-Research/Breeze2-VITS-onnx` 模型（繁体中文 TTS）。虽然模型可以正常加载和推理，生成的音频文件也存在且长度合理，但**所有生成的音频都无法对应输入文本**，完全听不清内容。

---

## 问题描述

### 现象
- ✅ 模型可以正常加载
- ✅ 推理成功，无错误
- ✅ 生成的音频文件存在且长度合理
- ✅ 音频数值范围正常
- ❌ **生成的音频无法对应输入文本，完全听不清内容**

### 测试文本
- 测试了多个句子（短句和长句）
- 测试了不同的编码格式
- 测试了不同的参数组合
- 测试了不同的采样率（16kHz, 22.05kHz, 24kHz）
- **所有测试结果都无法对应文本**

---

## 技术验证结果

### 1. 模型结构验证 ✅

**模型输入**:
- `x`: int64, shape [N, L] - token IDs
- `x_length`: int64, shape [N] - 序列长度
- `noise_scale`: float32, shape [1]
- `length_scale`: float32, shape [1]
- `noise_scale_w`: float32, shape [1]
- `sid`: int64, shape [1] - 说话人 ID

**模型输出**:
- `y`: float32, shape [N, 1, L] - 音频波形

**验证结果**: ✅ 模型结构正常

### 2. Tokenizer 编码验证 ⚠️

**Token 系统**:
- 使用注音符号（ㄅㄆㄇ）而非拼音
- 49 个 tokens（包括标点符号、注音符号、声调符号）
- Lexicon 包含 67,999 个汉字到注音符号的映射

**编码逻辑**:
- 中文文本 -> 查找 lexicon -> 注音符号序列 -> token IDs
- 例如："你" -> ['ㄋ', 'ㄧ', 'ˇ'] -> [13, 41, 46]

**验证结果**: ⚠️ 编码逻辑看起来正确，但生成的音频无法对应文本

### 3. 测试结果 ❌

**测试内容**:
- ✅ 测试了 3 种不同的编码格式（直接转换、开头加静音、字之间加空格）
- ✅ 测试了 3 组不同的参数组合
- ✅ 测试了 3 种不同的采样率（16kHz, 22.05kHz, 24kHz）
- ✅ 测试了多个不同长度的句子

**测试结果**:
- ❌ 所有格式和参数组合都无法生成可识别的音频
- ❌ 所有采样率都无法生成可识别的音频
- ❌ 所有长度的句子都无法生成可识别的音频

---

## 可能的原因分析

### 1. 编码格式问题（最可能）
- **假设**: 虽然我们按照 lexicon 转换了，但可能格式不对
- **证据**: 所有编码格式都无法生成可识别的音频
- **影响**: 可能需要查看原始实现或文档，确认正确的编码方式

### 2. 模型使用方式问题
- **假设**: 模型可能需要特定的使用方式或预处理
- **证据**: 模型可以正常推理，但输出质量异常
- **影响**: 可能需要参考原始实现的完整示例代码

### 3. 模型文件问题
- **假设**: ONNX 模型可能有问题
- **证据**: 模型可以正常推理，但输出质量异常
- **影响**: 可能需要使用原始 PyTorch 模型进行对比验证

### 4. 模型训练质量问题
- **假设**: 模型本身可能不适合直接使用
- **证据**: 所有参数组合都无法生成可识别的音频
- **影响**: 可能需要重新训练或使用其他模型

---

## 已尝试的解决方案

### 1. 编码格式调整
- ✅ 测试了 3 种不同的编码格式
- ❌ 所有格式都无法生成可识别的音频

### 2. 参数调优
- ✅ 测试了多组参数组合（noise_scale, length_scale, noise_scale_w）
- ❌ 所有参数组合都无法生成可识别的音频

### 3. 采样率调整
- ✅ 测试了 3 种不同的采样率（16kHz, 22.05kHz, 24kHz）
- ❌ 所有采样率都无法生成可识别的音频

### 4. 句子长度测试
- ✅ 测试了多个不同长度的句子
- ❌ 所有长度的句子都无法生成可识别的音频

---

## 建议的解决方案

### 方案 1: 查找原始实现或文档（推荐）
**优先级**: 高  
**时间成本**: 1-2 天  
**成功率**: 中等

**行动**:
1. 查找 `MediaTek-Research/Breeze2-VITS-onnx` 的 GitHub 仓库或文档
2. 查看是否有使用示例或文档
3. 确认正确的编码方式和使用方法
4. 修复我们的实现

**优点**:
- 如果成功，可以快速解决问题
- 不需要更换模型

**缺点**:
- 可能需要大量时间调查
- 原始实现可能不完整或有问题

---

### 方案 2: 使用其他中文 TTS 模型
**优先级**: 高  
**时间成本**: 2-3 天  
**成功率**: 高

**行动**:
1. 搜索其他可用的中文 TTS 模型
2. 下载并测试新模型
3. 如果可用，集成到现有系统

**优点**:
- 可能找到更可靠的模型
- 不需要深入调查当前模型的问题

**缺点**:
- 需要重新实现 tokenizer
- 可能需要调整系统架构

---

### 方案 3: 暂时只支持英文 TTS
**优先级**: 中  
**时间成本**: 0.5 天  
**成功率**: 高

**行动**:
1. 暂时禁用中文 TTS 功能
2. 只支持英文 TTS（MMS TTS 已验证可用）
3. 后续再添加中文 TTS 支持

**优点**:
- 可以快速上线英文功能
- 不影响整体项目进度

**缺点**:
- 功能不完整
- 需要后续再处理中文 TTS

---

## 推荐方案

**推荐**: **方案 2（使用其他中文 TTS 模型）** 或 **方案 3（暂时只支持英文 TTS）**

**理由**:
1. 当前模型经过多次测试仍无法解决问题，继续投入时间可能不划算
2. 方案 2 可能找到更可靠的模型，长期收益更高
3. 方案 3 可以快速上线，不影响整体进度

---

## 影响评估

### 对项目的影响
- **功能完整性**: 中文 TTS 功能暂时不可用
- **项目进度**: 可能需要额外 2-3 天处理
- **技术债务**: 如果选择方案 3，需要后续再处理中文 TTS

### 对用户的影响
- **用户体验**: 中文用户无法使用 TTS 功能
- **功能范围**: 仅支持英文 TTS

---

## 附件

### 相关文件
- `scripts/test_breeze2_vits_inference.py` - 基础推理测试脚本
- `scripts/test_breeze2_vits_detailed.py` - 详细测试脚本
- `scripts/test_breeze2_vits_long_sentences.py` - 长句子测试脚本
- `scripts/check_breeze2_vits_model.py` - 模型结构检查脚本

### 测试结果
- 所有测试脚本的输出结果
- 生成的音频文件（位于 `test_output/` 目录）

---

## 决策建议

**建议决策部门考虑**:
1. 是否继续投入时间调查当前模型的问题（方案 1）
2. 是否寻找其他中文 TTS 模型（方案 2）
3. 是否暂时只支持英文 TTS，后续再处理中文（方案 3）

**推荐决策**: 采用 **方案 2** 或 **方案 3**，因为当前模型经过充分测试仍无法解决问题，继续投入时间可能不划算。

---

**报告人**: AI Assistant  
**审核状态**: 待审核  
**下一步**: 等待决策部门决定采用的方案

