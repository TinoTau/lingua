# VITS 中文 AISHELL3 模型问题总结报告

**日期**: 2024-12-19  
**状态**: 阻塞 - 无法生成可识别的中文语音  
**优先级**: 高

---

## 执行摘要

在实现中文 TTS（文本转语音）功能时，我们集成了 `vits-zh-aishell3` 模型。虽然模型可以正常加载和推理，生成的音频文件也存在且长度合理，但**所有生成的音频都无法识别任何一个字**，语速和音质参数调整后问题依然存在。

经过详细的技术验证，我们确认：
- ✅ Tokenizer 编码逻辑正确
- ✅ 模型输入输出格式正确
- ✅ 模型可以正常推理
- ❌ **生成的音频完全无法识别**

---

## 问题描述

### 现象
- 生成的音频文件存在且长度合理（约 1-2 秒）
- 音频的数值范围正常（min=-0.015681, max=0.012289）
- 但播放时**无法识别任何一个字**，完全听不清内容

### 测试文本
- 测试文本: "你好，世界。"
- 预期输出: 清晰的中文语音
- 实际输出: 无法识别的音频

---

## 技术验证结果

### 1. Tokenizer 编码验证 ✅

**验证方法**:
- 对比原始实现的 `symbols.py` 和我们的 `tokens.txt`
- 验证关键 token 的 ID 映射

**验证结果**:
- ✅ Token 总数一致: 219 个
- ✅ Token 顺序完全一致
- ✅ 所有关键 token ID 匹配（sil=0, eos=1, sp=2, n=19, i3=81, h=14, ao3=51 等）
- ✅ 编码逻辑正确：`sil + 声母 + 韵母 + sp + ... + eos`

**示例编码**:
```
文本: "你好，世界。"
Token IDs: [0, 19, 81, 2, 14, 51, 2, 24, 117, 2, 15, 107, 2, 1]
解码: sil + n + i3 + sp + h + ao3 + sp + sh + iii4 + sp + j + ie4 + sp + eos
```

### 2. 模型输入输出验证 ✅

**模型输入**:
- `x`: int64, shape [N, L] - token IDs
- `x_length`: int64, shape [N] - 序列长度
- `noise_scale`: float32, shape [1] - 音调变化控制
- `length_scale`: float32, shape [1] - 语速控制
- `noise_scale_w`: float32, shape [1] - 音调变化控制（另一维度）
- `sid`: int64, shape [1] - 说话人 ID

**模型输出**:
- `y`: float32, shape [N, 1, L] - 音频波形

**验证结果**:
- ✅ 模型可以正常加载
- ✅ 推理成功，无错误
- ✅ 输出形状正确
- ✅ 输出数值范围正常

### 3. 参数调优测试 ❌

**测试内容**:
- 测试了 4 种不同的 tokenizer 编码格式
- 测试了 4 组不同的参数组合（noise_scale, length_scale, noise_scale_w）
- 测试了 11 个不同的说话人 ID（0-10）

**测试结果**:
- ❌ 所有格式和参数组合都无法生成可识别的音频
- ✅ 语速可以通过 `length_scale` 参数调整（2.0 时语速合理）
- ❌ 但即使语速合理，仍然无法识别任何一个字

### 4. 原始实现对比 ✅

**获取的文件**:
- `text/symbols.py` - Token 定义
- `text/__init__.py` - Tokenizer 基础函数
- `export_onnx_aishell3.py` - ONNX 导出脚本

**对比结果**:
- ✅ 我们的 `tokens.txt` 与原始实现的 `symbols.py` 完全一致
- ✅ Token ID 映射正确
- ⚠️ 未找到文本到 token 序列的完整转换逻辑（`text/chinese.py` 文件不存在）

---

## 可能的原因分析

### 1. 文本预处理问题（最可能）
- **假设**: 虽然 tokenizer 编码逻辑看起来正确，但可能缺少某些预处理步骤
- **证据**: 原始实现的 `text/chinese.py` 文件无法获取，无法确认完整的文本处理流程
- **影响**: 可能导致输入格式与模型训练时不一致

### 2. 模型文件问题
- **假设**: ONNX 模型导出可能存在问题
- **证据**: 模型可以正常推理，但输出质量异常
- **影响**: 可能需要使用原始 PyTorch 模型进行对比验证

### 3. 模型训练质量问题
- **假设**: 模型本身可能不适合直接使用
- **证据**: 所有参数组合都无法生成可识别的音频
- **影响**: 可能需要重新训练或使用其他模型

### 4. 模型使用方式问题
- **假设**: 模型可能需要特定的使用方式或后处理
- **证据**: 原始实现的完整使用示例无法获取
- **影响**: 可能需要参考原始实现的完整示例代码

---

## 已尝试的解决方案

### 1. Tokenizer 格式调整
- ✅ 测试了 4 种不同的编码格式（字之间加 sp、每个音节后加 sp、不加 sp 等）
- ❌ 所有格式都无法生成可识别的音频

### 2. 参数调优
- ✅ 测试了多组参数组合（noise_scale: 0.3-0.667, length_scale: 1.0-3.0, noise_scale_w: 0.4-0.8）
- ✅ 找到了语速合理的参数组合（noise_scale=0.5, length_scale=2.0, noise_scale_w=0.6）
- ❌ 但即使语速合理，仍然无法识别任何一个字

### 3. 说话人 ID 调整
- ✅ 测试了 11 个不同的说话人 ID（0-10）
- ❌ 所有说话人 ID 都无法生成可识别的音频

### 4. 原始实现对比
- ✅ 获取了原始实现的 symbols 定义
- ✅ 验证了 token 映射的正确性
- ⚠️ 无法获取完整的文本处理逻辑

---

## 建议的解决方案

### 方案 1: 深入调查原始实现（推荐）
**优先级**: 高  
**时间成本**: 1-2 天  
**成功率**: 中等

**行动**:
1. 手动查看原始仓库的完整代码（https://github.com/csukuangfj/vits_chinese）
2. 找到文本到 token 序列的完整转换逻辑
3. 对比我们的实现，找出差异
4. 修复我们的实现

**优点**:
- 如果成功，可以快速解决问题
- 不需要更换模型

**缺点**:
- 可能需要大量时间调查
- 原始实现可能不完整或有问题

---

### 方案 2: 使用其他中文 TTS 模型
**优先级**: 高  
**时间成本**: 2-3 天  
**成功率**: 高

**行动**:
1. 搜索其他可用的中文 TTS 模型（如 MMS TTS 中文版、其他 VITS 中文模型）
2. 下载并测试新模型
3. 如果可用，集成到现有系统

**优点**:
- 可能找到更可靠的模型
- 不需要深入调查当前模型的问题

**缺点**:
- 需要重新实现 tokenizer
- 可能需要调整系统架构

---

### 方案 3: 暂时只支持英文 TTS
**优先级**: 中  
**时间成本**: 0.5 天  
**成功率**: 高

**行动**:
1. 暂时禁用中文 TTS 功能
2. 只支持英文 TTS（MMS TTS 已验证可用）
3. 后续再添加中文 TTS 支持

**优点**:
- 可以快速上线英文功能
- 不影响整体项目进度

**缺点**:
- 功能不完整
- 需要后续再处理中文 TTS

---

### 方案 4: 使用原始 PyTorch 模型
**优先级**: 低  
**时间成本**: 3-5 天  
**成功率**: 中等

**行动**:
1. 下载原始 PyTorch 模型
2. 使用 PyTorch 进行推理测试
3. 如果 PyTorch 版本可以正常工作，再考虑 ONNX 转换问题

**优点**:
- 可以验证模型本身是否有问题
- 如果 PyTorch 版本可用，可以暂时使用

**缺点**:
- 需要 Python 运行时环境
- 不符合 Rust 架构要求
- 时间成本较高

---

## 推荐方案

**推荐**: **方案 2（使用其他中文 TTS 模型）** 或 **方案 3（暂时只支持英文 TTS）**

**理由**:
1. 当前模型经过多次测试仍无法解决问题，继续投入时间可能不划算
2. 方案 2 可能找到更可靠的模型，长期收益更高
3. 方案 3 可以快速上线，不影响整体进度

---

## 影响评估

### 对项目的影响
- **功能完整性**: 中文 TTS 功能暂时不可用
- **项目进度**: 可能需要额外 2-3 天处理
- **技术债务**: 如果选择方案 3，需要后续再处理中文 TTS

### 对用户的影响
- **用户体验**: 中文用户无法使用 TTS 功能
- **功能范围**: 仅支持英文 TTS

---

## 附件

### 相关文件
- `scripts/compare_symbols_with_tokens.py` - Token 对比脚本
- `scripts/test_different_tokenizer_formats.py` - 格式测试脚本
- `scripts/check_model_io_detailed.py` - 模型输入输出检查脚本
- `scripts/original_vits_code/` - 原始实现代码

### 测试结果
- 所有测试脚本的输出结果
- 生成的音频文件（位于 `test_output/` 目录）

---

## 决策建议

**建议决策部门考虑**:
1. 是否继续投入时间调查当前模型的问题（方案 1）
2. 是否寻找其他中文 TTS 模型（方案 2）
3. 是否暂时只支持英文 TTS，后续再处理中文（方案 3）

**推荐决策**: 采用 **方案 2** 或 **方案 3**，因为当前模型经过充分测试仍无法解决问题，继续投入时间可能不划算。

---

**报告人**: AI Assistant  
**审核状态**: 待审核  
**下一步**: 等待决策部门决定采用的方案

