# SileroVad 服务启动测试

## 概述

这个测试脚本用于验证 SileroVad 在服务启动时的初始化和基本功能。

## 测试内容

1. **模型文件检查** - 验证模型文件是否存在
2. **初始化测试** - 测试 SileroVad 的初始化和模型加载
3. **基本检测功能** - 测试语音和静音的检测
4. **自然停顿检测** - 测试自然停顿的检测和边界类型返回

## 使用方法

### 1. 确保模型文件存在

模型文件路径：`core/engine/models/vad/silero/silero_vad.onnx`

如果模型不存在，需要下载：
- 从 [Silero VAD GitHub](https://github.com/snakers4/silero-vad) 下载模型
- 或使用提供的下载脚本

### 2. 运行测试

```bash
cd core/engine
cargo run --example test_silero_vad_startup
```

### 3. 预期输出

测试成功时，应该看到类似以下输出：

```
============================================================
  SileroVad 服务启动测试
============================================================

[1/4] 检查模型文件...
✅ 模型文件存在: ...

[2/4] 初始化 SileroVad...
✅ SileroVad 初始化成功 (耗时: XXXms)
   配置:
     - 采样率: 16kHz
     - 帧大小: 512 samples (32ms)
     - 静音阈值: 0.5
     - 最小静音时长: 600ms

[3/4] 测试基本检测功能...
  3.1 测试语音帧（模拟语音信号）...
     ✅ 语音帧检测:
        - 边界: false
        - 置信度: 0.XXX
        - 边界类型: None
     ✅ 置信度正常（> 0.5，表示检测到语音）

  3.2 测试静音帧...
     ✅ 静音帧检测:
        - 边界: false
        - 置信度: 0.XXX
        - 边界类型: None
     ✅ 置信度正常（< 0.5，表示检测到静音）

[4/4] 测试自然停顿检测...
  发送语音帧 -> 静音帧序列（模拟自然停顿）...
  发送静音帧（等待检测到自然停顿）...
     ✅ 检测到自然停顿!
        - 静音帧数: XX
        - 静音时长: XXXms
        - 边界类型: Some(NaturalPause)
        - 置信度: 0.XXX
     ✅ 边界类型正确（NaturalPause）

[额外] 测试重置功能...
✅ 重置成功

============================================================
  测试完成
============================================================

总结:
  ✅ 模型加载: 成功
  ✅ 初始化: 成功
  ✅ 语音检测: 正常
  ✅ 静音检测: 正常
  ✅ 自然停顿检测: 成功

SileroVad 已准备就绪，可以在 CoreEngine 中使用！
```

## 故障排除

### 1. 模型文件不存在

**错误信息：**
```
❌ 模型文件不存在: ...
```

**解决方法：**
- 确保模型文件位于正确路径：`core/engine/models/vad/silero/silero_vad.onnx`
- 如果不存在，需要下载模型文件

### 2. 初始化失败

**错误信息：**
```
❌ SileroVad 初始化失败: ...
```

**可能原因：**
- ONNX Runtime 未正确安装
- 模型文件损坏
- 路径错误

**解决方法：**
- 检查 ONNX Runtime 是否正确安装
- 重新下载模型文件
- 检查模型文件路径

### 3. 未检测到自然停顿

**警告信息：**
```
⚠️  未检测到自然停顿（可能需要更多静音帧或调整配置）
```

**可能原因：**
- 静音帧数量不足（需要至少 600ms 的静音）
- 静音阈值设置过高

**解决方法：**
- 增加测试中的静音帧数量
- 调整配置中的 `min_silence_duration_ms` 或 `silence_threshold`

## 配置参数说明

测试使用的默认配置：
- **采样率**: 16kHz（SileroVad 要求）
- **帧大小**: 512 samples（32ms @ 16kHz）
- **静音阈值**: 0.5（低于此值认为是静音）
- **最小静音时长**: 600ms（超过此时长才判定为自然停顿）

可以在 `test_silero_vad_startup.rs` 中修改这些参数进行测试。

## 下一步

测试通过后，可以在 `lingua_core_config.toml` 中配置使用 SileroVad：

```toml
[vad]
type = "silero"
model_path = "models/vad/silero/silero_vad.onnx"
silence_threshold = 0.5
min_silence_duration_ms = 600
```

然后重新编译并启动 CoreEngine 服务。

